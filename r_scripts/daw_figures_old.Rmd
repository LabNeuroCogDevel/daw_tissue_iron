---
title: "daw_figures"
author: "Daniel Petrie"
date: "2024-06-03"
output: html_document
editor_options: 
  chunk_output_type: console
---

WD/Libraries/data

Note: At some point I should plot based on stored ggeffects modeling data directly.

DAN! Stop being lazy and clean this up you dork.

```{r Global}
library("ggplot2") #For plotting
library("GGally") #ggpairs()
library("tidyverse") #Wranglin
library("dplyr") #Wranglin
library("interactions")
library("lme4") #MLM
library("lmerTest") #p-vals
library("ggeffects") #For marginal/conditional effects plots
library("marginaleffects") #For hypothesis_test()
library("parameters") #Other useful marginal effects functions
library("gdata") #upperTriangle()
library("mgcv") #GAMM
library("ggpubr") #Combining plots
library("bmlm") #Centering made easy
library("neuroCombat") #Harminization
library("LNCDR") #waterfall plot, lunaize plots 
library("gratia") #mgcv companion package. Using draw among other funcs.
library("psych") #Descriptives
library("ggrain") #Raincloud plot
library("ggseg") #Brain images
library("ggseg3d") #3d brain images
library("see") #Theme modern
library("viridis") #Additional colors
library("viridisLite") #Additional colors
library("ggnewscale") #new_scale()
#library("corrplot") #Corrplot()
#Working directory (change to something better (onedrive?, something else?) at some point)
#Hera feels correct at this moment. All files could live in directory R for this project.
setwd("C:/Users/djpet/Documents/daw_resting_state")
full <- read.csv("daw_project_070324.csv", header = TRUE)
```

11475 visit 2 should be removed.
11498 visit 2 should be removed.
11589 visit 2 should be removed.


Cleaning


```{r Cleaning}
#Creating a different sex variable for some plots/analyses
full <- full %>%
  mutate(sex = as.character(sex),
    sex_p = case_when(
    sex == "M" ~ "Male",
    sex == "F" ~ "Female",
    TRUE ~ sex 
  ))

#Making visitnum a factor. Can change accordingly
full$visitnum <- as.factor(full$visitnum)

#Making sex a factor
full$sex <- as.factor(full$sex)

#Making an ordered factor.
full$sex_p <- ordered(full$sex_p, levels = (c("Male", "Female")))

#Inverse age for linear models.
full$inv_age <- 1/full$age

#Checking for duplicate rows due to weird merging situation I put myself in.
full[which(duplicated(full$modelbased)),c(1:3, 8, 20)] #11475_2/11498_2/11589_2 are duplicates.
#These ids have duplicated Daw visits, but different rest days. Taking rows with imaging data.

full <- full %>%
  filter(!(id == "11475" & visitnum == "2") & 
           !(id == "11498" & visitnum == "2") &
           !(id == "11589" & visitnum == "2"))

#Treating visitnum as numeric?
full$visitnum_numeric <- as.numeric(full$visitnum)

#Treating id as factor for og gam fitting
full$id_fac <- as.factor(full$id)
```


**Figure 1: Waterfall plot**
1)Waterfall plot (N subjects) (red + blue) (Same plot as puberty?)
(there will also be table 1 here)

**Figure 2: Task Image and Hypothesized MB/MF results**
2) (TOP): Daw Image
3) (Bottom): Hypothetical MB/MF

**Figure 3: Iron distributions and Age Iron Trajectories**
4) Raincould plot (Variability of tat2)
5) Age x tat2 plots

**Figure 4: Behavioral Results bar charts and Age Daw Trajectories**
6) Behavioral results (in stay_probability script)
7) Age x Daw plots

**Figure 5: Main Effect and Interaction plots**
8) After controlling for age, main effect of FSS on putamen iron 
9) age*mb interaction
10) age*fss interaction

(Consider adding range of significance here somehow)

**Waterfall plots**
Consider using theme_modern()

```{r Waterfall Plot}
age_ranked <- waterfall_group(full %>% 
                                dplyr::select(age, id, sex, study) %>%
                                filter(complete.cases(.)))

waterfall <- ggplot(data = age_ranked, 
               aes(x = age, y = age_id, group = age_id)) + 
  geom_line(aes(group = age_id, color = sex), alpha = .6) + 
  geom_point(aes(shape = sex, color=sex), alpha = .6) + 
  ylab("") + 
  xlab("Age (years)") + 
  theme_modern(base_size = 12) +
  theme(axis.title.y = element_blank(), 
        axis.ticks.y = element_blank(), 
        axis.text.y = element_blank(),
        axis.line.y = element_line(),
        legend.position=c(.15,.9), 
        legend.title=element_blank(), 
        axis.title.x = element_text(margin = margin(t = 10, 
                                                    r = 0, 
                                                    b = 0, 
                                                    l = 0)),
        panel.border = element_blank(),
        panel.grid.major = element_blank(), # Remove major grid lines
        panel.grid.minor = element_blank(),
        axis.line.x = element_line(),  # Increase x-axis line width
        axis.ticks.x = element_line(), # Increase x-axis ticks size
        axis.ticks.length = unit(0.2, "cm")) +  # Increase x-axis ticks length) + # Remove minor grid lines
  scale_color_manual(name = "Sex",
                     values = c("M" = "blue", "F" = "red"),
                     labels = c("M" = "Male", "F" = "Female")) + # Custom color labels
  scale_shape_manual(name = "Sex",
                     values = c("M" = 16, "F" = 17),
                     labels = c("M" = "Male", "F" = "Female"))
 
# Calculate table of sex counts for unique subject IDs
print(table(full$sex[match(unique(full$id), full$id)]))

dev.new(width = 90, height = 70, unit = "mm", noRStudioGD=TRUE)

waterfall

ggsave(filename = "manuscript_images/figure1.png", 
       plot = waterfall, 
       device = "png", 
       dpi = 300, 
       width = 90, 
       height = 70, 
       unit = "mm", 
       scale = 1.5)
```



```{r iron raincloud and iron trajectories}
#Selecting harmonized tat2 variables to plot. I'll grab inverse as well.
tat2_harm_inv <- full %>% 
  dplyr::select("id", "study",
                "harox_pallidum_harm",
                "harox_nacc_harm",
                "harox_putamen_harm", 
                "harox_caudate_harm")

#Pivot longer for raincloud plot.
tat2_full_harm <- pivot_longer(tat2_harm_inv, 
                        cols = starts_with("harox"), 
                        names_to = "roi", 
                        values_to = "beta")

#Change back to words for plotting
#tat2_full_harm <- tat2_full_harm %>%
#  mutate(study = ifelse(study == "1", "7t", "PET"))

#Custom labels
custom_labels <- c("Ca", 
                   "NAcc",
                   "GP", 
                   "Pu")

#Rainclooud plot by scanner
#lunaize(ggplot(tat2_full_harm %>% 
#         filter(complete.cases(.)), 
#       aes(x = roi, y = beta, fill = roi)) + 
#  geom_rain(alpha = 0.7) +
#  theme_bw() +
#  scale_y_continuous(trans = "reverse") +
#  scale_fill_brewer(palette = "Dark2") +
#  guides(fill = "none", color = "none") +
#  labs(x = "ROI", y = "R2*") +
#  scale_x_discrete(labels = custom_labels) +
#    facet_wrap(~study))

#Rainclooud plot for whole sample
rain <- ggplot(tat2_full_harm %>% 
         filter(complete.cases(.)), aes(x = roi, 
                                        y = beta, 
                                        fill = roi)) + 
  geom_rain(alpha = .7,
            boxplot.args.pos = list(
              width = 0.05, position = position_nudge(x = 0.13)),
            violin.args.pos = list(
              side = "r",
              width = 0.7, position = position_nudge(x = 0.2))) +
  theme_modern(base_size = 14, axis.title.face = "plain") +
  scale_y_continuous(breaks = c(1.3, 1.2, 1.1, 1.0, 0.9, 
                                0.8, 0.7, 0.6, 0.5, 0.4), trans = "reverse") +
  scale_fill_brewer(palette = "Dark2") +
  guides(fill = "none", color = "none") +
  labs(x = "ROI", y = "nT2*w") +
  scale_x_discrete(labels = custom_labels) +
  theme(
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16)
  )
rain
#ggsave(filename = "flux_images/iron_test.pdf", plot = rain, width = 2.5, height = 2.5, dpi = 500)
#All plotted together over time
iron_long <- full %>%
  pivot_longer(cols = c(harox_pallidum_harm, 
                        harox_caudate_harm, 
                        harox_nacc_harm,
                        harox_putamen_harm),
               names_to = "outcome", 
               values_to = "value")
#All in the same plot. Weird because no stars for significance... need to figure that whole thing out.
#This could also be useful later on?
#Adding stars for significance
stars_df <- data.frame(
  x = c(33.2, 33.2, 33.2, 33.2),
  y = c(0.92, 0.83, 0.53, 0.80),
  outcome = c("Ca", "NAcc", "GP", "Pu"), # Outcomes
  star = c("***", "***", "***", "***"),
  angle = c(0, 0, 0, 0)# Significance stars
)

iron_age <- ggplot(data = iron_long, 
                   aes(x=age, y=value, colour = outcome)) + 
  geom_point(alpha = 0.5)+
  geom_line(aes(group = interaction(id, outcome)), alpha = 0.5) +
  theme_modern(base_size = 14, axis.title.face = "plain") + 
  scale_y_continuous(trans = "reverse") + 
  geom_smooth(method = "gam", 
              formula = y ~ s(x, bs = "tp"), 
              se = TRUE, 
              aes(group = outcome, 
                  fill = outcome),
              alpha = 0.6,
              linewidth = .8,
              color = "black") + 
  labs(x = "Age (years)", 
       y = "", 
       color = "ROI: ") + 
  scale_color_brewer(palette = "Dark2", 
                     labels = c("Ca", "NAcc", "GP", "Pu")) + 
  scale_fill_brewer(palette = "Dark2", 
                    labels = c("Ca", "NAcc", "GP", "Pu"), guide = FALSE) +
  theme(legend.position = "none", 
        strip.text = element_blank())  +
  theme(
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16)
  )

iron_age

ggarrange(rain, iron_age, 
          labels = c("A.", "B."),
          ncol = 2,
          nrow = 1, 
          #common.legend = TRUE, 
          legend = "none") #Maybe top instead?
#ggsave(filename = "flux_images/daw_behave.png", plot = combined_plot, width = 12, height = 10, dpi = 300, units = "cm")
```


**Daw age trajectories**


```{r Daw age trajectories}
daw_long <- full %>%
  pivot_longer(cols = c(firststagestay_z, modelbased_z, modelfree_z), 
               names_to = "outcome", 
               values_to = "value")

#All in the same plot. Weird because no stars for significance... need to figure that whole thing out.
#This could also be useful later on?
# Define new labels for the facets
new_labels <- c("firststagestay_z" = "First Stage Stay (z-scored)",
                "modelbased_z" = "Model Based (z-scored)",
                "modelfree_z" = "Model Free (z-scored)")

ggplot(data = daw_long, 
               aes(x=age, y=value, group = id, colour = outcome)) + 
  geom_point(alpha = 0.7) +
  geom_line(alpha = 0.7) +
  theme_bw() +
  geom_smooth(method = "gam", formula = y ~ s(x, bs = "cs"), aes(group = outcome, fill = outcome)) + 
  #guides(fill = "none", color = "none") +
  labs(x = "\n Age", y = "") +
  scale_color_brewer(palette = "Dark2", 
                     labels = c("First Stage Stay (z-scored)", 
                                "Model Based (z-scored)", 
                                "Model Free (z-scored)")) +
  scale_fill_brewer(palette = "Dark2", 
                    labels = c("First Stage Stay (z-scored)", 
                                "Model Based (z-scored)", 
                                "Model Free (z-scored)"), guide = FALSE) +
  #facet_wrap(~outcome)) +  
  theme(panel.border = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        text=element_text(size=12),
        axis.text.y = element_text(hjust = 0.1, color='black'),
        axis.text.x = element_text(vjust = 0.1,color='black'),
        legend.position = "none",
        strip.background = element_blank(),
        strip.text = element_text(color = 'black')) +
  facet_wrap(~outcome, labeller = as_labeller(new_labels))

#600 pixels
#Doing this in pieces in order to add significance stars appropiately.

mb_age <- lunaize(ggplot(data = full, 
               aes(x=age, y=modelbased_z, group = id)) + 
  geom_point(size = 2, alpha = 0.7) +
  geom_line() +
  theme_bw() +
  ylim(-3, 3) +
  stat_smooth(method = "gam",  aes(group = 1), color = "black", linewidth = 1.5) +
  #guides(fill = "none", color = "none") +
  labs(x = "Age", y = "RL Parameter Estimates", title = "Model Based (z-scored)")) +
  #scale_color_manual(values = c("blue", "red"), name = "Sex")) +
  theme(legend.position = "bottom")  +
  geom_text(aes(x = 33.7, y = .5, 
                label = "***"), 
            size = 6,
            color = "black",
            angle = 90) 
mb_age

mf_age <- lunaize(ggplot(data = full, 
               aes(x=age, y=modelfree_z, group = id)) + 
  geom_point(size = 2, alpha = 0.7) +
  geom_line() +
  theme_bw() +
  ylim(-3, 3) +
  stat_smooth(method = "gam",  aes(group = 1), color = "black", linewidth = 1.5) +
  #guides(fill = "none", color = "none") +
  labs(x = "Age", y = "", title = "Model Free (z-scored)")) +
 #scale_color_manual(values = c("blue", "red"), name = "Sex")) +
  theme(legend.position = "bottom")  +
  geom_text(aes(x = 33.7, y = .9, 
                label = "***"), 
            size = 6,
            color = "black",
            angle = 90) 
mf_age

fss_age <- lunaize(ggplot(data = full, 
               aes(x = age, y = firststagestay_z, group = id)) + 
  geom_point(size = 2, alpha = 0.7) +
  geom_line() +
  theme_bw() +
  ylim(-3, 3) +
  stat_smooth(method = "gam",  aes(group = 1), color = "black", linewidth = 1.5) +
  #guides(fill = "none", color = "none") +
  labs(x = "Age", y = "", title = "First Stage Stay (z-scored)")) +
#scale_color_manual(values = c("blue", "red"), name = "Sex")) +
  theme(legend.position = "bottom")  +
  geom_text(aes(x = 33.7, y = .95, 
                label = "***"), 
            size = 6,
            color = "black",
            angle = 90) 
fss_age

#Combining
ggarrange(mb_age, mf_age, fss_age,
          labels = c("A.", "B.", "C."),
          ncol = 3,
          nrow = 1, 
          common.legend = TRUE, 
          legend = "bottom")
```


**Main effect plot**

I could potential plot both smooths on top of each other to show the opposite effects.

```{r Main effect plot}
me_plot <- ggplot(full, 
                  aes(x = fss_resid_z, y = harox_putamen_harm, group = id)) +
  geom_point() +
  scale_y_continuous(trans = "reverse") + 
  stat_smooth(method = "gam",  aes(group = 1), color = "black", linewidth = 1.5, fullrange = F) +
  labs(x = "First Stage Stay (z-scored)",
       y = "Putamen nT2*w") +
  theme_modern(base_size = 14) +
  theme(
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16)
  )
  
me_plot
```


Interactions of interest. The idea is that we want to see whether these reinforcement learning parameters differentially relate the trajectories of the iron measures.


```{r s(Age):FSS Model}
mod_put_int <- gam(harox_putamen_harm ~ 1 + sex + visitnum_numeric  +
                 s(age, k = 3, fx = F) +
                 s(age, by = mb_resid_z, k = 3, fx = F) +
                 s(age, by = fss_resid_z, k = 3, fx = F) +
                   s(id_fac, bs = "re"),
                 method = "REML",
                 data = full)
summary(mod_put_int)
#draw(mod_put_int)


#fss margins
mod_put_int_fss_margins <- ggpredict(mod_put_int, 
                                     terms = c("age", "fss_resid_z[-2,-1,0,1,2]"))

#MB margins
mod_put_int_mb_margins <- ggpredict(mod_put_int, 
                                     terms = c("age", "mb_resid_z[-2,-1,0,1,2]"))



```

Derivatives to add to plots. My current take is that this plot is literally identical to the J/N plot (because they are!). I think I like the approach where you show simple slopes, and they add the region of sig with geom_vline.

```{r Derivatives}
#Extract derivatives
d <- derivatives(mod_put_int, 
                 n = 200)
#Plot derivatives
draw(d)

#Calculate regions of significance, where CI != 0
d <- d %>% mutate(sig = !(0>.lower_ci & 0<.upper_ci))

#Split data into s(age) and s(age):FSS
d_age <- d %>% slice(1:200)
d_age_mb <- d %>% slice(201:400)
d_age_fss <- d %>% slice(401:600)
#Range of significane for age
cat(sprintf(
  "\nSignificant change: %1.2f - %1.2f\n",
  min(d_age$age[d_age$sig==T]),
  max(d_age$age[d_age$sig==T]))) 

#Age range of significance for Age:MB
cat(sprintf(
  "\nSignificant change: %1.2f - %1.2f\n",
  min(d_age_mb$age[d_age_mb$sig==T]),
  max(d_age_mb$age[d_age_mb$sig==T]))) 

#Age range of significance for Age:FSS
cat(sprintf(
  "\nSignificant change: %1.2f - %1.2f\n",
  min(d_age_fss$age[d_age_fss$sig==T]),
  max(d_age_fss$age[d_age_fss$sig==T])))

#ggplot(data = d_age_fss,aes(x=age,y = .derivative, color=sig, ymin=.lower_ci,ymax=.upper_ci)) + #geom_ribbon(fill="black",alpha=.3,color=NA) + geom_line(size=1,show.legend = F) +scale_color_manual(values = c("TRUE" #= "firebrick","FALSE" = "black")) + geom_hline(yintercept = 0,linetype=2) + scale_y_continuous(transform = "reverse")
```



```{r Interaction figures cont. USE!}
#age:fss viridis "D"
p1 <- ggplot() +
  geom_point(data = full, 
             aes(x = age, 
                 y = harox_putamen_harm, 
                 color = fss_resid_z, 
                 group = id)) + 
  geom_line(data = full, 
            aes(x = age, 
                y = harox_putamen_harm, 
                color = fss_resid_z, 
                group = id)) +
  scale_color_viridis(option = "D", 
                      direction = -1, 
                      alpha = .5,
                      name = "FSS (z-scored)",
                      guide = guide_colorbar(position = "bottom")) +
  scale_fill_viridis(option = "D", 
                     direction = -1, 
                     alpha = .5) +
  new_scale_color() +
  new_scale_fill() +
  geom_smooth(data = mod_put_int_fss_margins, 
              aes(x = x, 
                  y = predicted, 
                  group = group, 
                  color = group), 
              linewidth = 1.5) +
  scale_color_viridis(discrete = TRUE, 
                      option = "D",
                      direction = -1, 
                      guide = "none") + 
  scale_y_continuous(trans = "reverse") +
  labs(title = "Age x FSS Interaction",
       x = "Age (years)",
       y = "Putamen nT2*w") + 
  theme_modern(base_size = 12) +
  geom_text(aes(x = 28, y = 1.1), 
            label = expression("s(Age):FSS " * italic(F) * " = 3.35, " * italic(p) * " = 0.015"),
            size = 4, 
            color = "black") +
  geom_text(aes(x = 15, y = 0.7),
            label = "p < 0.05",
            size = 4,
            color = "black") +
   geom_text(aes(x = 19.5, y = 0.7),
            label = "n.s.",
            size = 4,
            color = "black") +
  theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    plot.title = element_text(hjust = 0.5)) +
  geom_vline(xintercept = 17.81, 
             linetype = "dashed", 
             color = "black", 
             linewidth = 1)
p1

#age:MB plasma "C"
p2 <- ggplot() +
  geom_point(data = full, 
             aes(x = age, 
                 y = harox_putamen_harm, 
                 color = mb_resid_z, 
                 group = id)) + 
  geom_line(data = full, 
            aes(x = age, 
                y = harox_putamen_harm, 
                color = mb_resid_z, 
                group = id)) +
  scale_color_viridis(option = "C", 
                      direction = -1, 
                      alpha = .5,
                      name = "MB (z-scored)",
                      guide = guide_colorbar(position = "bottom")) +
  scale_fill_viridis(option = "C", 
                     direction = -1, 
                     alpha = .5) +
  new_scale_color() +
  new_scale_fill() +
  geom_smooth(data = mod_put_int_mb_margins, 
              aes(x = x, 
                  y = predicted, 
                  group = group, 
                  color = group), 
              size = 1.5) +
  #geom_ribbon(data = mod_put_int_mb_margins, 
  #            aes(x = x, 
  #                ymin = conf.low, 
  #                ymax = conf.high, 
  #                fill = group), 
  #            alpha = 0.2) +
  scale_color_viridis(discrete = TRUE, 
                      option = "C", 
                      direction = -1, 
                      guide = "none") + 
  #scale_fill_viridis(discrete = TRUE, 
  #                   option = "C", 
  #                   direction = -1, 
  #                   guide = "none") +
  scale_y_continuous(trans = "reverse") +
  labs(title = "Age x MB Interaction",
       x = "Age (years)",
       y = "Putamen nT2*w") + 
  theme_modern() +
  geom_text(aes(x = 28, y = 1.1), 
            label = expression("s(Age):MB " * italic(F) * " = 3.62, " * italic(p) * " = 0.014"),
            size = 4, 
            color = "black") +
  geom_text(aes(x = 16, y = 0.7),
            label = "p < 0.05",
            size = 4,
            color = "black") +
   geom_text(aes(x = 20, y = 0.7),
            label = "n.s.",
            size = 4,
            color = "black") +
  theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    plot.title = element_text(hjust = 0.5)) +
  geom_vline(xintercept = 18.39, 
             linetype = "dashed", 
             color = "black", 
             linewidth = 1)
p2
q3 <- ggarrange(p1, p2,
          labels = c("A.", "B."),
          ncol = 2,
          nrow = 1, 
          common.legend = FALSE, 
          legend = "bottom")
q3
#dev.new(width = 190, height = 140, unit = "mm", noRStudioGD=TRUE)
#ggsave(filename = "flux_images/interaction_test2.png", plot = q3, device = "png", dpi = 300, width = 190, height = 140, unit = "mm", scale = 1.5)
#This looks to be close to the right dimensions? Scaling looks like it could be appropriate? 
```

**Sensitivity Models**

```{r Sensitivity s(age):FSS models}
#post dorsal put
sensitivity_pos_dputamen <- gam(cic_pos_dorsal_put_harm ~ 1 + sex + visitnum_numeric + 
                       s(age, k = 3, fx = F) +
                s(age, by = fss_resid_z, k = 3, fx = F) +
                s(age, by = mb_resid_z, k = 3, fx = F) +
                s(id_fac, bs = "re"),
                     method = "REML",
                     data = full)


summary(sensitivity_pos_dputamen)
#Plots for viewing fast
#plot(ggpredict(sensitivity_pos_dputamen, 
#               terms = c("age", "mb_resid_z[-2,2]"))) + scale_y_continuous(trans = "reverse")
#plot(ggpredict(sensitivity_pos_dputamen, 
#               terms = c("age", "fss_resid_z[-2,2]"))) + scale_y_continuous(trans = "reverse")
pos_dput_int_fss_margins <- ggpredict(sensitivity_pos_dputamen, 
                                      terms = c("age", "fss_resid_z[-2,-1,0,1,2]"))

pos_dput_int_mb_margins <- ggpredict(sensitivity_pos_dputamen, 
                                      terms = c("age", "mb_resid_z[-2,-1,0,1,2]"))


#post ventral put
sensitivity_pos_vputamen <- gam(cic_pos_ventral_put_harm ~ 1 + sex + visitnum_numeric + 
                       s(age, k = 3, fx = F) +
                s(age, by = fss_resid_z, k = 3, fx = F) +
                s(age, by = mb_resid_z, k = 3, fx = F) +
                s(id_fac, bs = "re"),
                     method = "REML",
                     data = full)

#summary(test_2$gam)
summary(sensitivity_pos_vputamen)
#plot(ggpredict(sensitivity_pos_vputamen, 
#               terms = c("age", "mb_resid_z[-2,2]"))) + scale_y_continuous(trans = "reverse")
#plot(ggpredict(sensitivity_pos_vputamen, 
#               terms = c("age", "fss_resid_z[-2,2]"))) + scale_y_continuous(trans = "reverse")
pos_vput_int_fss_margins <- ggpredict(sensitivity_pos_vputamen, 
                                      terms = c("age", "fss_resid_z[-2,-1,0,1,2]"))

pos_vput_int_mb_margins <- ggpredict(sensitivity_pos_vputamen, 
                                      terms = c("age", "mb_resid_z[-2,-1,0,1,2]"))
```


**Sensitivity derivatives**

```{r Sensitivity Derivatives}
#Extract derivatives
dorsal <- derivatives(sensitivity_pos_dputamen, 
                 n = 200)
#Plot derivatives
draw(dorsal)

#Calculate regions of significance, where CI != 0
dorsal <- dorsal %>% mutate(sig = !(0>.lower_ci & 0<.upper_ci))

#Split data into s(age) and s(age):FSS
dorsal_age <- dorsal %>% slice(1:200)
dorsal_age_fss <- dorsal %>% slice(201:400)
dorsal_age_mb <- dorsal %>% slice(401:600)
#Range of significane for age
cat(sprintf(
  "\nSignificant change: %1.2f - %1.2f\n",
  min(dorsal_age$age[dorsal_age$sig==T]),
  max(dorsal_age$age[dorsal_age$sig==T]))) 

#Age range of significance for Age:MB
cat(sprintf(
  "\nSignificant change: %1.2f - %1.2f\n",
  min(dorsal_age_mb$age[dorsal_age_mb$sig==T]),
  max(dorsal_age_mb$age[dorsal_age_mb$sig==T]))) 

#Age range of significance for Age:FSS
cat(sprintf(
  "\nSignificant change: %1.2f - %1.2f\n",
  min(dorsal_age_fss$age[dorsal_age_fss$sig==T]),
  max(dorsal_age_fss$age[dorsal_age_fss$sig==T])))

#ggplot(data = d_age_fss,aes(x=age,y = .derivative, color=sig, ymin=.lower_ci,ymax=.upper_ci)) + #geom_ribbon(fill="black",alpha=.3,color=NA) + geom_line(size=1,show.legend = F) +scale_color_manual(values = c("TRUE" #= "firebrick","FALSE" = "black")) + geom_hline(yintercept = 0,linetype=2) + scale_y_continuous(transform = "reverse")

#Extract derivatives
ventral <- derivatives(sensitivity_pos_vputamen, 
                 n = 200)
#Plot derivatives
draw(ventral)

#Calculate regions of significance, where CI != 0
ventral <- ventral %>% mutate(sig = !(0>.lower_ci & 0<.upper_ci))

#Split data into s(age) and s(age):FSS
ventral_age <- ventral %>% slice(1:200)
ventral_age_fss <- ventral %>% slice(201:400)
ventral_age_mb <- ventral %>% slice(401:600)
#Range of significane for age
cat(sprintf(
  "\nSignificant change: %1.2f - %1.2f\n",
  min(ventral_age$age[ventral_age$sig==T]),
  max(ventral_age$age[ventral_age$sig==T]))) 

#Age range of significance for Age:MB
cat(sprintf(
  "\nSignificant change: %1.2f - %1.2f\n",
  min(ventral_age_mb$age[ventral_age_mb$sig==T]),
  max(ventral_age_mb$age[ventral_age_mb$sig==T]))) 

#Age range of significance for Age:FSS
cat(sprintf(
  "\nSignificant change: %1.2f - %1.2f\n",
  min(ventral_age_fss$age[ventral_age_fss$sig==T]),
  max(ventral_age_fss$age[ventral_age_fss$sig==T])))

#ggplot(data = d_age_fss,aes(x=age,y = .derivative, color=sig, ymin=.lower_ci,ymax=.upper_ci)) + #geom_ribbon(fill="black",alpha=.3,color=NA) + geom_line(size=1,show.legend = F) +scale_color_manual(values = c("TRUE" #= "firebrick","FALSE" = "black")) + geom_hline(yintercept = 0,linetype=2) + scale_y_continuous(transform = "reverse")
```

**Sensitivity plots**
4 of these...

```{r Sensitivity Plots}
#pos dorsal put age:fss mako "G"
p3 <- ggplot() +
  geom_point(data = full, 
             aes(x = age, 
                 y = cic_pos_dorsal_put_harm, 
                 color = fss_resid_z, 
                 group = id)) + 
  geom_line(data = full, 
            aes(x = age, 
                y = cic_pos_dorsal_put_harm, 
                color = fss_resid_z, 
                group = id)) +
  scale_color_viridis(option = "G", 
                      direction = -1, 
                      alpha = .5,
                      name = "FSS (z-scored)",
                      guide = guide_colorbar(position = "bottom")) +
  scale_fill_viridis(option = "G", 
                     direction = -1, 
                     alpha = .5) +
  new_scale_color() +
  new_scale_fill() +
  geom_smooth(data = pos_dput_int_fss_margins, 
              aes(x = x, 
                  y = predicted, 
                  group = group, 
                  color = group), 
              linewidth = 1.5) +
  scale_color_viridis(discrete = TRUE, 
                      option = "G",
                      direction = -1, 
                      guide = "none") + 
  scale_y_continuous(trans = "reverse") +
  labs(title = "Age x FSS Interaction",
       x = "Age (years)",
       y = "PD Putamen nT2*w") + 
  theme_modern(base_size = 16) +
  geom_text(aes(x = 28, y = 1.1), 
            label = expression("s(Age):FSS " * italic(F) * " = 3.53, " * italic(p) * " = 0.016"),
            size = 4, 
            color = "black") +
  geom_text(aes(x = 15.35, y = 0.7),
            label = "p < 0.05",
            size = 4,
            color = "black") +
   geom_text(aes(x = 19.35, y = 0.7),
            label = "n.s.",
            size = 4,
            color = "black") +
  theme(
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    plot.title = element_text(hjust = 0.5)) +
  geom_vline(xintercept = 17.35, 
             linetype = "dashed", 
             color = "black", 
             linewidth = 1)
p3

#pos dorsal put age:mb rocket "F"
p4 <- ggplot() +
  geom_point(data = full, 
             aes(x = age, 
                 y = cic_pos_dorsal_put_harm, 
                 color = mb_resid_z, 
                 group = id)) + 
  geom_line(data = full, 
            aes(x = age, 
                y = cic_pos_dorsal_put_harm, 
                color = mb_resid_z, 
                group = id)) +
  scale_color_viridis(option = "F", 
                      direction = -1, 
                      alpha = .5,
                      name = "MB (z-scored)",
                      guide = guide_colorbar(position = "bottom")) +
  scale_fill_viridis(option = "F", 
                     direction = -1, 
                     alpha = .5) +
  new_scale_color() +
  new_scale_fill() +
  geom_smooth(data = pos_dput_int_mb_margins, 
              aes(x = x, 
                  y = predicted, 
                  group = group, 
                  color = group), 
              linewidth = 1.5) +
  scale_color_viridis(discrete = TRUE, 
                      option = "F",
                      direction = -1, 
                      guide = "none") + 
  scale_y_continuous(trans = "reverse") +
  labs(title = "Age x MB Interaction",
       x = "Age (years)",
       y = "PD Putamen nT2*w") + 
  theme_modern(base_size = 16) +
  geom_text(aes(x = 28, y = 1.1), 
            label = expression("s(Age):MB " * italic(F) * " = 4.95, " * italic(p) * " = 0.003"),
            size = 4, 
            color = "black") +
  geom_text(aes(x = 16.74, y = 0.7),
            label = "p < 0.05",
            size = 4,
            color = "black") +
   geom_text(aes(x = 20.74, y = 0.7),
            label = "n.s.",
            size = 4,
            color = "black") +
  theme(
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    plot.title = element_text(hjust = 0.5)) +
  geom_vline(xintercept = 18.74, 
             linetype = "dashed", 
             color = "black", 
             linewidth = 1)
p4


#pos ventral put age:fss mako "G"
#Need to adjust geom_text layers
#Also something looks weird
p5 <- ggplot() +
  geom_point(data = full, 
             aes(x = age, 
                 y = cic_pos_ventral_put_harm, 
                 color = fss_resid_z, 
                 group = id)) + 
  geom_line(data = full, 
            aes(x = age, 
                y = cic_pos_ventral_put_harm, 
                color = fss_resid_z, 
                group = id)) +
  scale_color_viridis(option = "G", 
                      direction = -1, 
                      alpha = .5,
                      name = "FSS (z-scored)",
                      guide = guide_colorbar(position = "bottom")) +
  scale_fill_viridis(option = "G", 
                     direction = -1, 
                     alpha = .5) +
  new_scale_color() +
  new_scale_fill() +
  geom_smooth(data = pos_vput_int_fss_margins, 
              aes(x = x, 
                  y = predicted, 
                  group = group, 
                  color = group), 
              linewidth = 1.5) +
  scale_color_viridis(discrete = TRUE, 
                      option = "G",
                      direction = -1, 
                      guide = "none") + 
  scale_y_continuous(trans = "reverse") +
  labs(title = "Age x FSS Interaction",
       x = "Age (years)",
       y = "PV Putamen nT2*w") + 
  theme_modern(base_size = 16) +
  geom_text(aes(x = 28, y = 1.21), 
            label = expression("s(Age):FSS " * italic(F) * " = 4.17, " * italic(p) * " = 0.007"),
            size = 4, 
            color = "black") +
  geom_text(aes(x = 14.54, y = 0.63),
            label = "p < 0.05",
            size = 4,
            color = "black") +
   geom_text(aes(x = 18.54, y = 0.63),
            label = "n.s.",
            size = 4,
            color = "black") +
  theme(
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    plot.title = element_text(hjust = 0.5)) +
  geom_vline(xintercept = 16.54, 
             linetype = "dashed", 
             color = "black", 
             linewidth = 1)
p5

#pos dorsal put age:mb rocket "F"
p6 <- ggplot() +
  geom_point(data = full, 
             aes(x = age, 
                 y = cic_pos_ventral_put_harm, 
                 color = mb_resid_z, 
                 group = id)) + 
  geom_line(data = full, 
            aes(x = age, 
                y = cic_pos_ventral_put_harm, 
                color = mb_resid_z, 
                group = id)) +
  scale_color_viridis(option = "F", 
                      direction = -1, 
                      alpha = .5,
                      name = "MB (z-scored)",
                      guide = guide_colorbar(position = "bottom")) +
  scale_fill_viridis(option = "F", 
                     direction = -1, 
                     alpha = .5) +
  new_scale_color() +
  new_scale_fill() +
  geom_smooth(data = pos_vput_int_mb_margins, 
              aes(x = x, 
                  y = predicted, 
                  group = group, 
                  color = group), 
              linewidth = 1.5) +
  scale_color_viridis(discrete = TRUE, 
                      option = "F",
                      direction = -1, 
                      guide = "none") + 
  scale_y_continuous(trans = "reverse") +
  labs(title = "Age x MB Interaction",
       x = "Age (years)",
       y = "PV Putamen nT2*w") + 
  theme_modern(base_size = 16) +
  geom_text(aes(x = 28, y = 1.21), 
            label = expression("s(Age):MB " * italic(F) * " = 3.49, " * italic(p) * " = 0.017"),
            size = 4, 
            color = "black") +
  geom_text(aes(x = 16.74, y = 0.63),
            label = "p < 0.05",
            size = 4,
            color = "black") +
   geom_text(aes(x = 20.74, y = 0.63),
            label = "n.s.",
            size = 4,
            color = "black") +
  theme(
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    plot.title = element_text(hjust = 0.5)) +
  geom_vline(xintercept = 18.74, 
             linetype = "dashed", 
             color = "black", 
             linewidth = 1)
p6

q4 <- ggarrange(p3,p5,p4,p6, 
          labels = c("A.", "B.", "C.", "D."),
          ncol = 2,
          nrow = 2, 
          common.legend = FALSE, 
          legend = "bottom")
q4
#This actually sorta works?
ggsave(filename = "flux_images/sense_interactionstestt.png", plot = q4, device = "png", dpi = 500, width = 190, height = 140, unit = "mm", scale = 1.5)
```


**Sensitivity Atlas Iron distributions**

I need to subset full and grab id, age, visit, scanner and cic variables 

```{r Sensitivity Iron Distributions}
#Using grep to select columns I want.
columns_to_select <- grep("^(?!.*_z).*cic.*harm|harm.*cic", 
                          names(full), 
                          value = TRUE, 
                          perl = TRUE)

#Subsetting
tat2_full_harm <- full %>%
  select(id, visitnum, age, sex, study, all_of(columns_to_select))
#Pivot longer for raincloud plot.
tat2_full_long_harm <- pivot_longer(tat2_full_harm, 
                        cols = starts_with("cic"), 
                        names_to = "roi", 
                        values_to = "beta")

custom_labels <- c("PD Putamen", 
                   "PV Putamen",
                   "AD Putamen", 
                   "AV Putamen")

#Rainclooud plot for whole sample
rain <- ggplot(tat2_full_long_harm %>%
                 filter(roi == c("cic_pre_dorsal_put_harm", 
                        "cic_pre_ventral_put_harm", 
                        "cic_pos_dorsal_put_harm", 
                        "cic_pos_ventral_put_harm")) %>% 
                 filter(complete.cases(.)), aes(x = roi, 
                                                y = beta, 
                                                fill = roi)) + 
  geom_rain(alpha = .7,
            boxplot.args.pos = list(
              width = 0.05, position = position_nudge(x = 0.13)),
            violin.args.pos = list(
              side = "r",
              width = 0.7, position = position_nudge(x = 0.2))) +
  theme_modern(base_size = 16, axis.title.face = "plain") +
  scale_y_continuous(breaks = c(1.3, 1.2, 1.1, 1.0, 0.9, 
                                0.8, 0.7, 0.6, 0.5, 0.4), trans = "reverse") +
  scale_fill_brewer(palette = "Dark2") +
  guides(fill = "none", color = "none") +
  labs(x = "ROI", y = "nT2*w") +
  scale_x_discrete(labels = custom_labels) +
  theme(
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    axis.text.x = element_blank(),
    axis.text.y = element_text(size = 16)
  )
rain

#Trajectories
iron_age <- ggplot(data = tat2_full_long_harm %>%
                 filter(roi == c("cic_pre_dorsal_put_harm", 
                        "cic_pre_ventral_put_harm", 
                        "cic_pos_dorsal_put_harm", 
                        "cic_pos_ventral_put_harm")) %>% 
                 filter(complete.cases(.)), 
                   aes(x=age, y=beta, colour = roi)) + 
  geom_point(alpha = 0.5)+
  geom_line(aes(group = interaction(id, roi)), alpha = 0.5) +
  theme_modern(base_size = 16) + 
  scale_y_continuous(trans = "reverse") + 
  geom_smooth(method = "gam", 
              formula = y ~ s(x, bs = "tp"), 
              se = TRUE, 
              aes(group = roi, 
                  fill = roi),
              alpha = 0.6,
              linewidth = .8,
              color = "black") + 
  labs(x = "Age (years)", 
       y = "", 
       color = "ROI: ") + 
  scale_color_brewer(palette = "Dark2", 
                     labels = custom_labels) + 
  scale_fill_brewer(palette = "Dark2", 
                    labels = custom_labels, guide = FALSE) +
  theme(#legend.position = "none", 
        strip.text = element_blank())  +
  theme(
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16)
  ) + facet_wrap(~roi)

iron_age

q5 <- ggarrange(rain, iron_age, 
          labels = c("A.", "B."),
          ncol = 2,
          nrow = 1, 
          common.legend = TRUE, 
          legend = "bottom") #Maybe top instead?
q5
ggsave(filename = "flux_images/sense_iront.png", 
       plot = q5, device = "png", 
       dpi = 500, width = 190, height = 120, unit = "mm", scale = 1.5)
```


**J/N plots**


```{r Johnson Neyman Plots}
#Fitting w/gamm because of speed
mod_put_int <- gam(harox_putamen_harm ~ 1 + sex + visitnum_numeric  +
                 s(age, k = 3, fx = TRUE) +
                 s(age, by = mb_resid_z, k = 3, fx = TRUE) +
                 s(age, by = fss_resid_z, k = 3, fx = TRUE) +
                   s(id, bs = "re"),
                 method = "REML",
                 data = full)
summary(mod_put_int)
#J/N plot (if it ever finishes running.)
int_pred <- predict_response(mod_put_int, terms = c("fss_resid_z", "age"))
ggeffects::johnson_neyman(int_pred)
jn_plot <- plot(ggeffects::johnson_neyman(int_pred))

#Yikes...
jn_plot + scale_y_continuous(transform = "reverse") +
  theme_modern(base_size = 14) +
  theme(
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16)
  ) +
  labs(x = "Age (years)",
       y = "Slope of FSS",
       title = "")

#J/N plot (if it ever finishes running.)
int_pred1 <- predict_response(mod_put_int, terms = c("age", "fss_resid_z"))
#ggeffects::johnson_neyman(int_pred)
jn_plot1 <- plot(ggeffects::johnson_neyman(int_pred1))

#Yikes...
jn_plot1 + scale_y_continuous(transform = "reverse") +
  theme_modern(base_size = 14) +
  theme(
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16)
  ) +
  #labs(x = "Age (years)",
  #     y = "Slope of FSS",
  #     title = "")

#Flipped is less convincing.
```





























































































Attempting to make tiny for moving to inkscape

```{r Interaction small}
p1 <- ggplot() +
  geom_point(data = full, 
             aes(x = age, 
                 y = harox_putamen_harm, 
                 color = fss_resid_z, 
                 group = id)) + 
  geom_line(data = full, 
            aes(x = age, 
                y = harox_putamen_harm, 
                color = fss_resid_z, 
                group = id)) +
  scale_color_viridis(option = "D", 
                      direction = -1, 
                      alpha = .5,
                      name = "FSS (z-scored)",
                      guide = guide_colorbar(position = "bottom")) +
  scale_fill_viridis(option = "D", 
                     direction = -1, 
                     alpha = .5) +
  new_scale_color() +
  new_scale_fill() +
  geom_smooth(data = mod_put_int_fss_margins, 
              aes(x = x, 
                  y = predicted, 
                  group = group, 
                  color = group), 
              size = 1.5) +
  geom_ribbon(data = mod_put_int_fss_margins, 
              aes(x = x, 
                  ymin = conf.low, 
                  ymax = conf.high, 
                  fill = group), 
              alpha = 0.2) +
  scale_color_viridis(discrete = TRUE, 
                      option = "D", 
                      direction = -1, 
                      guide = "none") + 
  scale_fill_viridis(discrete = TRUE, 
                     option = "D", 
                     direction = -1, 
                     guide = "none") +
  scale_y_continuous(trans = "reverse") +
  labs(title = "Age x FSS Interaction",
       x = "Age (years)",
       y = "Putamen nT2*w") + 
  theme_modern(base_size = 12) +
  geom_text(aes(x = 28, y = 1.1), 
            label = expression("s(Age):FSS " * italic(F) * " = 3.35, " * italic(p) * " = 0.02"),
            size = 3, 
            color = "black") +
  geom_text(aes(x = 15, y = 0.7),
            label = "p < 0.05",
            size = 3,
            color = "black") +
   geom_text(aes(x = 19, y = 0.7),
            label = "n.s.",
            size = 3,
            color = "black") +
  theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    plot.title = element_text(hjust = 0.5)) +
  geom_vline(xintercept = 17.81, 
             linetype = "dashed", 
             color = "black", 
             linewidth = 1)
p1

ggsave(filename = "interation_test1.svg", plot = p1, device = "svg", dpi = 500, units = "mm", width = 80, height = 75)
#MB
p2 <- ggplot() +
  geom_point(data = full, 
             aes(x = age, 
                 y = harox_putamen_harm, 
                 color = mb_resid_z, 
                 group = id)) + 
  geom_line(data = full, 
            aes(x = age, 
                y = harox_putamen_harm, 
                color = mb_resid_z, 
                group = id)) +
  scale_color_viridis(option = "C", 
                      direction = -1, 
                      alpha = .5,
                      name = "MB (z-scored)",
                      guide = guide_colorbar(position = "bottom")) +
  scale_fill_viridis(option = "C", 
                     direction = -1, 
                     alpha = .5) +
  new_scale_color() +
  new_scale_fill() +
  geom_smooth(data = mod_put_int_mb_margins, 
              aes(x = x, 
                  y = predicted, 
                  group = group, 
                  color = group), 
              size = 1.5) +
  geom_ribbon(data = mod_put_int_mb_margins, 
              aes(x = x, 
                  ymin = conf.low, 
                  ymax = conf.high, 
                  fill = group), 
              alpha = 0.2) +
  scale_color_viridis(discrete = TRUE, 
                      option = "C", 
                      direction = -1, 
                      guide = "none") + 
  scale_fill_viridis(discrete = TRUE, 
                     option = "C", 
                     direction = -1, 
                     guide = "none") +
  scale_y_continuous(trans = "reverse") +
  labs(title = "Age x MB Interaction",
       x = "Age (years)",
       y = "Putamen nT2*w") + 
  theme_modern(base_size = 12) +
  geom_text(aes(x = 28, y = 1.1), 
            label = expression("s(Age):MB " * italic(F) * " = 3.62, " * italic(p) * " = 0.01"),
            size = 3, 
            color = "black") +
  geom_text(aes(x = 16, y = 0.7),
            label = "p < 0.05",
            size = 3,
            color = "black") +
   geom_text(aes(x = 20, y = 0.7),
            label = "n.s.",
            size = 3,
            color = "black") +
  theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    plot.title = element_text(hjust = 0.5)) +
  geom_vline(xintercept = 18.39, 
             linetype = "dashed", 
             color = "black", 
             linewidth = 1)
p2
q3 <- ggarrange(p1, p2,
          labels = c("A.", "B."),
          ncol = 2,
          nrow = 1, 
          common.legend = FALSE, 
          legend = "bottom")
q3

ggsave(filename = "interation_test.svg", plot = q3, device = "svg", dpi = 500, units = "mm", width = 190, height = 150)
```

Ok. Let's try and plot both data frames at once to see if that looks better.

```{r interaction figure discrete DONT USE}
mod_int_plot_1 <- ggplot(mod_put_int_fss_margins, aes(x = x, y = predicted, group = group)) +
  theme_modern(base_size = 14) +
  #geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2) +
  geom_smooth(method = "gam", 
              formula = y ~ s(x, bs = "tp"), 
              se = FALSE, 
              aes(group = group, 
                  fill = group,
                  colour = group),
              alpha = 0.8,
              linewidth = 2) +
  geom_point(data = full, aes(x = age, y = harox_putamen_harm, group = id), alpha = 0.3, inherit.aes = FALSE) +
  geom_line(data = full, aes(x = age, y = harox_putamen_harm, group = id), alpha = 0.3, inherit.aes = FALSE) +
  scale_y_continuous(transform = "reverse") + 
  scale_color_manual(values = c("#1B9E77", "#D95F02", "#7570B3", "#E7298A", "#E6AB02"),
                     labels = c("-2 SD FSS", 
                                "Average FSS",
                                "High FSS",
                                "t",
                                "y"),
                     name = "",
                     guide = guide_legend(position = "bottom"),
                     breaks = unique(mod_put_int_fss_margins$group)) + # Define custom colors
  scale_fill_manual(values = c("#1B9E77", "#D95F02", "#7570B3", "#E7298A", "#E6AB02"),
                    guide = "none") +
  labs(title = "Age x First Stage Stay",
       x = "Age (years)", 
       y = "Putamen nT2*w") +
  geom_text(aes(x = 28, y = 1.1), 
            label = expression("s(Age):FSS " * italic(F) * " = 3.35, " * italic(p) * " = 0.02"),
            size = 4, 
            color = "black") +
  geom_text(aes(x = 16, y = 0.7),
            label = "p < 0.05",
            size = 4,
            color = "black") +
   geom_text(aes(x = 19, y = 0.7),
            label = "n.s.",
            size = 4,
            color = "black") +
  theme(
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16)) +
  geom_vline(xintercept = 17.81, linetype = "dashed", color = "black", linewidth = 1)

mod_int_plot_1



mod_int_plot_2 <- ggplot(mod_put_int_mb_margins, aes(x = x, y = predicted, group = group)) +
  theme_modern(base_size = 14) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2) +
  geom_smooth(method = "gam", 
              formula = y ~ s(x, bs = "tp"), 
              se = FALSE, 
              aes(group = group, 
                  fill = group,
                  colour = group),
              alpha = 0.8,
              linewidth = 2) +
  geom_point(data = full, aes(x = age, y = harox_putamen_harm, group = id), alpha = 0.3, inherit.aes = FALSE) +
  geom_line(data = full, aes(x = age, y = harox_putamen_harm, group = id), alpha = 0.3, inherit.aes = FALSE) +
  scale_y_continuous(transform = "reverse") + 
  scale_color_manual(values = c("#1B9E77", "#D95F02", "#7570B3"),
                     labels = c("Low MB", 
                                "Average MB",
                                "High MB"),
                     name = "",
                     guide = guide_legend(position = "bottom"),
                     breaks = unique(mod_put_int_fss_margins$group)) + # Define custom colors
  scale_fill_manual(values = c("#1B9E77", "#D95F02", "#7570B3"),
                    guide = "none") +
  labs(title = "Age x Model Based",
       x = "Age (years)", 
       y = "Putamen nT2*w") +
  geom_text(aes(x = 28, y = 1.1), 
            label = expression("s(Age):MB " * italic(F) * " = 3.62, " * italic(p) * " = 0.01"),
            size = 4, 
            color = "black") +
  geom_text(aes(x = 16, y = 0.7),
            label = "p < 0.05",
            size = 4,
            color = "black") +
   geom_text(aes(x = 19, y = 0.7),
            label = "n.s.",
            size = 4,
            color = "black") +
  theme(
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16)) +
  geom_vline(xintercept = 17.81, linetype = "dashed", color = "black", linewidth = 1)

mod_int_plot_2

#Combining
q1 <- ggarrange(mod_int_plot_1, mod_int_plot_2,
          labels = c("A.", "B."),
          ncol = 2,
          nrow = 1, 
          common.legend = FALSE, 
          legend = "bottom")
q1
```



Messing around with trying to add confidence intervals to the plots.


```{r Trying to add signficance box}
mod_int_plot_1 + geom_vline(xintercept = 18.39, linetype = "dotted", color = "red", size = 1)

q <- draw(d[401:600,]) + geom_vline(xintercept = 18.39, linetype = "dotted", color = "red", linewidth = 1) +
  geom_hline(yintercept = 0, linetype = "dotted", color = "red", linewidth = 1) +
  scale_y_continuous(trans = "reverse") 

t <- draw(d[201:400,]) + geom_vline(xintercept = 18.74, linetype = "dotted", color = "red", linewidth = 1) +
  geom_hline(yintercept = 0, linetype = "dotted", color = "red", linewidth = 1) +
  scale_y_continuous(trans = "reverse")
#Meh

ggarrange(mod_int_plot_1, q, mod_int_plot_2, t,
          labels = c("A.", "B.", "C.", "D."),
          ncol = 2,
          nrow = 2, 
          common.legend = FALSE, 
          legend = "bottom")

#It seems that geom_raster is being used here... to make rectangle. x = age, y = 1 , fill with significance
deriv_range <- range(d_age_mb$.derivative, na.rm=T)
ggplot(d, aes(x = age, y = 1, fill = sig)) +
  geom_raster(interpolate = TRUE) +
   scale_fill_gradient2(
        low = "blue", mid = "white", high = "red",
        midpoint = 0,
        space = "Lab",
        breaks=sort(c(0, range(deriv_range))),
        limits = deriv_range)



  tile <-
     ggplot(ci[-1, ]) + # don't plot first row (is NA)
     aes(x=ages, y=1, fill=!!sym(fill_column)) +
     geom_raster(interpolate=TRUE) +
     scale_fill_gradient2(
        low = "blue", mid = "white", high = "red",
        midpoint = 0,
        space = "Lab",
        breaks=sort(c(0, deriv_range)), # assumes range covers 0
        limits=deriv_range
      ) +
     xlab(sprintf("\n%s", xplotname))
  
ggplot(d_age_mb, aes(x = age, y = 1, fill = sig)) +
  geom_tile()  +
  scale_fill_gradient(low = "blue", high = "white", 
                      breaks = seq(0, 0.05, by = 0.01), 
                      labels = c("0.00", "0.01", "0.02", "0.03", "0.04", "0.05"),
                      limits = c(0, 0.05)) +
  theme_minimal() +
  labs(x = "Age", y = NULL, fill = "Significance") +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
```
































Points and llines? This approach sorta works... grr


```{r}
mod_put_int_fss_margins_plot1 <- plot(mod_put_int_fss_margins, 
                                     show_data = TRUE, 
                                     jitter = .1, 
                                     #dot_alpha = 0.4, 
                                     colors = c("#1B9E77", 
                                                "#D95F02"),
                                     show_legend = FALSE,
                                     alpha = .5,
                                     dot_alpha = .8,
                                     line_size = 1) 
mod_put_int_fss_margins_plot1
#Marginal plot fss This sorta works.
mod_int_plot_11 <- lunaize(mod_put_int_fss_margins_plot1  + 
                           labs(title = "FSS",
                                x = "Age", 
                                y = "Putamen nT2*w") + 
                           geom_text(aes(x = 13, y = 0.75, 
                                         label = 
                                           "s(Age)* \ns(Age):FSS*"), #Not sure how I feel about this.
                                     size = 6, 
                                     color = "black") +
                             scale_y_continuous(trans = "reverse")) #+  
                           #geom_line() +
                          # geom_ribbon(aes(
                          #   ymin = mod_put_int_fss_margins_plot$data$conf.low, 
                          #   ymax = mod_put_int_fss_margins_plot$data$conf.high,
                          #   fill = 
                          #     factor(mod_put_int_fss_margins_plot$data$group_col)),
                          #   alpha = 0.1) + 
                          # scale_color_manual(values = c("#1B9E77", 
                          #                               "#D95F02"), 
                          #                    labels = c(
                          #                      "More Exploratory", 
                          #                      "More Habitual"),
                          #                    name = "", 
                          #                    guide = 
                          #                      guide_legend(
                          #                        position = "bottom")) + 
                          #scale_fill_manual(values = c("#1B9E77", 
                          #                             "#D95F02"), 
                          #                  name = "Test", 
                          #                  guide = 
                          #                    guide_legend(
                          #                      position = "bottom")))
mod_int_plot_11


mod_put_int_mb_margins_plot <- plot(mod_put_int_mb_margins, 
                                     show_data = TRUE, 
                                     jitter = .1, 
                                     #dot_alpha = 0.4, 
                                     colors = c("#1B9E77", 
                                                "#D95F02"),
                                     show_legend = FALSE,
                                     alpha = .5,
                                     dot_alpha = .8,
                                     line_size = 1) 
mod_put_int_mb_margins_plot
#Marginal plot fss This sorta works.
mod_int_plot_22 <- lunaize(mod_put_int_mb_margins_plot  + 
                           labs(title = "MB",
                                x = "Age", 
                                y = "Putamen nT2*w") + 
                           geom_text(aes(x = 13, y = 0.75, 
                                         label = 
                                           "s(Age)* \ns(Age):MB*"), #Not sure how I feel about this.
                                     size = 6, 
                                     color = "black") +
                             scale_y_continuous(trans = "reverse")) #+  
                           #geom_line() +
                          # geom_ribbon(aes(
                          #   ymin = mod_put_int_fss_margins_plot$data$conf.low, 
                          #   ymax = mod_put_int_fss_margins_plot$data$conf.high,
                          #   fill = 
                          #     factor(mod_put_int_fss_margins_plot$data$group_col)),
                          #   alpha = 0.1) + 
                          # scale_color_manual(values = c("#1B9E77", 
                          #                               "#D95F02"), 
                          #                    labels = c(
                          #                      "More Exploratory", 
                          #                      "More Habitual"),
                          #                    name = "", 
                          #                    guide = 
                          #                      guide_legend(
                          #                        position = "bottom")) + 
                          #scale_fill_manual(values = c("#1B9E77", 
                          #                             "#D95F02"), 
                          #                  name = "Test", 
                          #                  guide = 
                          #                    guide_legend(
                          #                      position = "bottom")))
mod_int_plot_22


#Combining
q2 <- ggarrange(mod_int_plot_11, mod_int_plot_22,
          labels = c("A.", "B."),
          ncol = 2,
          nrow = 1, 
          common.legend = FALSE, 
          legend = "bottom")
q2



































test <- lunaize(mod_put_int_mb_margins_plot  + 
                           labs(title = "",
                                x = "Age", 
                                y = "Putamen nT2*w") + 
                           geom_text(aes(x = 13, y = 0.75, 
                                         label = 
                                           "s(Age)* \ns(Age):MB*"), #Not sure how I feel about this.
                                     size = 6, 
                                     color = "black") +
                             scale_y_continuous(trans = "reverse") + 
                           geom_line(aes(
                             color = factor(
                               mod_put_int_mb_margins_plot$data$group_col))) +
                           geom_ribbon(aes(
                             ymin = mod_put_int_mb_margins_plot$data$conf.low, 
                             ymax = mod_put_int_mb_margins_plot$data$conf.high,
                             fill = 
                               factor(mod_put_int_mb_margins_plot$data$group_col)),
                             alpha = 0.1) + 
                           scale_color_manual(values = c("#1B9E77", 
                                                         "#D95F02"), 
                                              labels = c(
                                                "Less Goal-directed", 
                                                "More Goal-directed"),
                                              name = "", 
                                              guide = 
                                                guide_legend(
                                                  position = "bottom")) + 
                           scale_fill_manual(values = c("#1B9E77", 
                                                        "#D95F02"), 
                                             name = "", 
                                             guide = 
                                               guide_legend(
                                                 position = "bottom")))
test + geom_point(data = full, aes(x = age, y = harox_putamen_harm))

iron_age <- lunaize(ggplot(data = iron_long %>% filter(outcome == "harox_putamen_harm") , 
                           aes(x=age, y=value, group = id, colour = firststagestay_z)) + 
                      theme_bw() + 
                      geom_point() +
                      geom_line() +
                      scale_y_continuous(trans = "reverse") + 
                      geom_smooth(method = "gam", 
                                  formula = y ~ s(x, by = colour, bs = "tp"), 
                                  se = TRUE, 
                                  aes(group = firststagestay_z, 
                                      fill = firststagestay_z))) +
  theme(legend.position = "top", 
        strip.text = element_blank())

iron_age

geom_text(data = stars_df,
            aes(x = x, y = y, label = star, ,
            angle = angle),
            color = "black",
            size = 6,
            vjust = -0.5))

labs(x = "Age", y = "nT2*w", color = "ROI: ") + 
                      scale_color_brewer(palette = "Dark2", 
                                         labels = c("Ca", "NAcc", "GP", "Pu")) + 
                      scale_fill_brewer(palette = "Dark2", 
                                        labels = c("Ca", "NAcc", "GP", "Pu"), guide = FALSE)
ggarrange(rain, iron_age, 
          labels = c("A.", "B."),
          ncol = 2,
          nrow = 1, 
          common.legend = TRUE, 
          legend = "top") #Maybe top instead?
```


?GGPAIRS??

```{r}
ggplot(full, aes(x=age, y = firststagestay, group = id)) +
  geom_point() +
  geom_line() 
  
a <- lmer(firststagestay ~ 1 + sex + visitnum + age + harox_putamen_harm + harox_caudate_harm + (1|id), data = full)
summary(a)
# +s(age, by = firststagestay_z, k = 3, fx = TRUE)
mod_put_int <- gamm(modelfree ~ 1 + sex_p + visitnum  +
                      s(age, k = 3, fx = T) +
                 s(age, by = harox_putamen_harm, k = 3, fx = T)   + 
                   s(age, by = harox_caudate_harm, k = 3, fx = T),
                 random = list(id = ~1),
                 method = "REML",
                 data = full)
summary(mod_put_int$gam)
draw(mod_put_int)
mod_put_int_fss_marginss <- ggpredict(mod_put_int$gam, 
                                     terms = c("age", "harox_putamen_harm"))
plot(mod_put_int_fss_marginss)
#MB margins
mod_put_int_mb_margins <- ggpredict(mod_put_int$gam, 
                                     terms = c("age", "harox_caudate_harm"))
plot(mod_put_int_mb_margins)

summary(gamm(firststagestay ~ 1 + sex_p + visitnum  +
                      s(age, k = 3, fx = T) +
                 harox_putamen_harm*harox_caudate_harm,
                 random = list(id = ~1),
                 method = "REML",
                 data = full)$gam)
```

```{r}
#WTH is this?
too_small <- function(x) abs(x) < 10^-15
clip_on_sig <- function(ci){
  # if confidence interval includes zero
  # signs of x and y will be different, -x * +y  < 0
  # or if both high and low are extremly close to zero
  not_sig <- ci$ci_low * ci$ci_high < 0 |
    (too_small(ci$ci_low) & too_small(ci$ci_high))
  ci$mean_dff_clip <- ci$mean_dff
  ci$mean_dff_clip[not_sig] <- 0
  return(ci)
}
lunaize_geomraster<-function(x){
  x+
    theme_bw()+
    theme(
      axis.line = element_line(colour = "black"),
      panel.grid.minor = element_blank(),
      panel.grid.major = element_blank(),
      axis.title.y     = element_blank(),
      axis.ticks.y     = element_blank(),
      axis.text.y      = element_blank(),
      axis.title.x     = element_blank(),
      axis.ticks.x     = element_blank(),
      axis.text.x      = element_blank(),
      legend.position  = "none")+
    theme(plot.margin = unit(c(0, 0, 0, 0), "cm"))
}
lunaize_geomrasterxkeep<-function(x){
  x+
    theme_bw()+
    theme(
      panel.grid.minor = element_blank(),
      panel.grid.major = element_blank(),
      axis.title.y     = element_blank(),
      axis.ticks.y     = element_blank(),
      axis.text.y      = element_blank(),
      legend.position  = "none")+
    theme(plot.margin = unit(c(0, 0, 0, 0), "cm"))
}
```


Fin plot (keep)

```{r Bivariate iron x fss/mb binned by age}
age_bins <- cut(full$age,
                breaks = c(10,13,17,24,34),
                labels = c("10-13", "14-17", "18-24", "25-34"),
                include.lowest = TRUE)
full <- full %>%
  mutate(age_group = age_bins)


a <- ggplot(full, aes(x = harox_putamen_harm, y = firststagestay, group = id)) +
  geom_point() +
  #geom_line() +
  scale_x_continuous(trans = "reverse") + 
  stat_smooth(method = "gam",  aes(group = 1), color = "black", linewidth = 1.5, fullrange = F) 

b <- ggplot(full, aes(x = harox_putamen_harm, y = modelbased, group = id)) +
  geom_point() +
  #geom_line() +
  scale_x_continuous(trans = "reverse") + 
  stat_smooth(method = "gam",  aes(group = 1), color = "black", linewidth = 1.5, fullrange = F)

c <- ggplot(full, aes(x = harox_putamen_harm, y = firststagestay, group = id)) +
  geom_point() +
  #geom_line() +
  scale_x_continuous(trans = "reverse") + 
  stat_smooth(method = "gam",  aes(group = 1), color = "black", linewidth = 1.5, fullrange = F) +
  facet_wrap(~age_group, scales = "free_x", nrow = 1)

d <- ggplot(full, aes(x =  harox_putamen_harm, y = modelbased, group = id)) +
  geom_point() +
  #geom_line() +
  scale_x_continuous(trans = "reverse") + 
  stat_smooth(method = "gam",  aes(group = 1), color = "black", linewidth = 1.5, fullrange = F) +
  facet_wrap(~age_group, scales = "free_x", nrow = 1)
ggarrange(a,c,b,d)
ggarrange(c,d, nrow = 2)
```



Trajectories by study (keep)

```{r Iron trajectories by study}
iron_age <- lunaize(ggplot(data = iron_long, 
                           aes(x=age, y=value, colour = outcome)) + 
                      theme_bw() + 
                      scale_y_continuous(trans = "reverse") + 
                      geom_smooth(method = "gam", 
                                  formula = y ~ s(x, bs = "tp"), 
                                  se = TRUE, 
                                  aes(group = outcome, 
                                      fill = outcome)) + 
                      labs(x = "Age", y = "nT2*w", color = "ROI: ") + 
                      scale_color_brewer(palette = "Dark2", 
                                         labels = c("Ca", "NAcc", "GP", "Pu")) + 
                      scale_fill_brewer(palette = "Dark2", 
                                        labels = c("Ca", "NAcc", "GP", "Pu"), guide = FALSE)) + facet_wrap(~study + outcome)
          #              geom_text(data = stars_df,
          #  aes(x = x, y = y, label = star, ,
          #  angle = angle),
          #  color = "black",
          #  size = 6,
          #  vjust = -0.5)) + 
  theme(legend.position = "top", 
        strip.text = element_blank()) + facet_wrap(~study + ROI)

iron_age
```



```{r For poster}

mod_put_int <- gamm(harox_putamen_harm ~ 1 + sex_p + visitnum  +
                 s(age, k = 3, fx = T) +
                 s(modelbased_z, k = 3, fx = TRUE) +
                #   s(modelfree_z, k = 3, fx = TRUE) +
                 s(age, by = firststagestay_z, k = 3, fx = TRUE),
                 random = list(id = ~1),
                 method = "REML",
                 data = full)
summary(mod_put_int$gam)
draw(mod_put_int, residuals = TRUE)
appraise(mod_put_int$gam)
draw(mod_put_int)
plot(ggpredict(mod_put_int, terms = c("firststagestay_z")), show_data = TRUE) + scale_y_continuous(trans = "reverse")
plot(ggpredict(mod_put_int, terms = c("age", "firststagestay_z")), show_data = TRUE) + scale_y_continuous(trans = "reverse") + theme_modern(base_size = 14)
plot(ggpredict(mod_put_int, terms = c("modelbased_z")), show_data = TRUE) + scale_y_continuous(trans = "reverse")
#Linear?
mod_put_lin <- lmer(firststagestay~ 1 + sex + visitnum + inv_age * harox_putamen_harm + (1|id), data = full)
summary(mod_put_lin)
plot(ggpredict(mod_put_lin, terms = c("inv_age", "harox_putamen_harm")), show_data = TRUE)
```

Habit on x, putamen nT2*w on y.

```{r Here for poster}
pred <- ggpredict(mod_put_int, terms = c("age", "firststagestay_z[-2,2]"), show_data = TRUE, jitter = 0.1)
lunaize(plot(ggpredict(mod_put_int, terms = c("age", "firststagestay_z[-2,2]")), show_data = TRUE, jitter = 0.1) +
  scale_y_continuous(trans = "reverse") +
  theme_bw() +
  #  geom_line(size = 1.5) +
  labs(title = "",
       x = "Age", 
       y = "Putamen nT2*w")) +
  geom_text(aes(x = 33.1, y = .80, 
                label = "**"), 
            size = 6,
            color = "black",
            angle = 90) +
  scale_color_manual(values = c("red", "blue"),
                     labels = c("More Exploratory",
                                "More Habitual"))

pred <- ggpredict(mod_put_int, terms = c("age", "firststagestay_z[-2,2]"), show_data = TRUE, jitter = 0.1)
#pred$group <- factor(pred$group, levels = c("-2","2"), labels = c("More Exploratory", "More Habitual"))
#levels(pred$group) <- c("More Exploratory", "More Habitual")
pred_plot <- plot(pred, show_data = TRUE, jitter = 0.1, show_legend = FALSE)
#pred_plot <- pred_plot + scale_color_manual(values = c("More Exploratory" = "blue", "More Habitual" = "red"))

#pred_plot$data$group <- as.factor(pred_plot$data$group)
#levels(pred_plot$data$group) <- c("More Exploratory", "More Habitual")
#pred$group <- factor(pred$group, levels = c("-2", "2"), labels = c("More Exploratory", "More Habitual"))
lunaize(pred_plot + 
  scale_y_continuous(trans = "reverse") +
  theme_bw() +
  #  geom_line(size = 1.5) +
  labs(title = "",
       color = "",
       x = "Age", 
       y = "Putamen nT2*w") +
  geom_text(aes(x = 33.1, y = .80, 
                label = "**"), 
            size = 6,
            color = "black",
            angle = 90)) 
```

```{r Linear models with pi and w}
#Linear equivalent
mod_put_lin <- lmer(harox_putamen_harm ~ 1 + sex + visitnum  + inv_age +
                 #modelbased_z +
                #   s(modelfree_z, k = 3, fx = TRUE) +
                       + firststagestay_z  +
                  #age:firststagestay_z +
                  #age:modelbased_z +
                  inv_age:firststagestay_z +
                  (1|id),
                 data = full)
summary(mod_put_lin)
plot(ggpredict(mod_put_lin, terms = c("inv_age", "firststagestay_z[-1,1]")), show_data = TRUE) + scale_y_continuous(trans = "reverse") + scale_x_continuous(trans = "reverse")

#interactions::johnson_neyman(mod_put_lin, pred = modelbased_z, modx = age)
interactions::johnson_neyman(mod_put_lin, pred = firststagestay_z, modx = inv_age)

mod <- lmer(harox_putamen_harm ~ 1 + sex + visitnum_numeric + age +
                       firststagestay_z + modelbased_z + modelfree_z +
                  (1|id),
                 data = full)
summary(mod)

mod <- lmer(harox_putamen_harm ~ 1 + sex + visitnum_numeric + inv_age +
                       pi_z + w_z + inv_age:pi_z + inv_age:w_z +
                  (1|id),
                 data = full)
summary(mod)

plot(ggpredict(mod, terms = c("inv_age", "pi_z[-2,-1,0,1,2]"))) + scale_y_continuous(trans = "reverse") + scale_x_continuous(trans = "reverse")

mod <- lmer(pi ~ 1 + sex + visitnum_numeric + age +
                       harox_putamen_harm  + age:harox_putamen_harm +
                  (1|id),
                 data = full)
summary(mod)

check <- gam(harox_putamen_harm ~ 1 + sex + visitnum_numeric +
               s(age, k = 3, fx = TRUE) + pi_z*w_z +
               #s(age, by = pi_z, k = 3, fx = TRUE) +
               s(w_z, k = 3, fx = TRUE) +
               s(id_fac, bs = "re"),
             method = "REML",
             data = full)
summary(check)
plot(ggpredict(check, terms = c("age", "pi_z"))) + scale_y_continuous(trans = "reverse")
```

This might only be useful when plotting putamen? 

```{r ggseg}
library(ggseg)
library(ggseg3d)
library(ggsegExtra)
#hoa <- data.frame(
#  region = c("caudate", "pallidum", "putamen", "accumbens area")#,
 # p = sample(seq(0,0.01,0.05), 4),
#  stringsAsFactors = FALSE
#ggseg(.data = hoa, mapping = aes(fill = region), atlas = "aseg") + theme_void()


data("aseg")
# Filter the regions to include only the specified subcortical structures
subcortical_regions <- c("putamen")
aseg_filtered <- aseg[aseg$data$region %in% subcortical_regions, ]

# Plot the filtered regions
ggplot() +
  geom_brain(atlas = aseg_filtered, aes(fill = region)) +
  theme_void() +
  labs(title = "Subcortical Structures: Putamen, Caudate, Pallidum, and Nucleus Accumbens")

someData = data.frame(
  region = c("transverse temporal", "insula",
           "precentral","superior parietal"), 
  p = sample(seq(0,.5,.001), 4),
  stringsAsFactors = FALSE)



data <- data.frame(
  region = c(
             brain_regions(aseg)[16]
             ),
  reg_col = c(
              brain_regions(aseg)[16]
              )
)
test <- ggplot(data = data) +
  geom_brain(atlas = aseg, aes(fill = reg_col), side = "coronal", show.legend = FALSE)  +
  #scale_fill_brain2(aseg$palette[data$region]) + 
                      theme_void()

"#EC0DB0"
test
ggarrange(test, mod_int_plot_1)
```

ggseg3d?
ggsegExtra has it! It does not actually. Just cortex.
```{r}
q <- aseg_3d
brain_regions(aseg_3d)
ggseg3d(atlas = aseg_3d) %>%
  add_glassbrain() %>%
  remove_axes() %>%
  pan_camera("axial")

somData_aseg = aseg_3d %>% 
  unnest(cols = ggseg_3d) %>% 
  select(label) %>% 
  filter(grepl("Pallidum|Putamen|Caudate|Accumbens-area", label)) %>% 
  mutate(p = seq(1, nrow(.)))

ggseg3d(.data = somData_aseg, atlas = aseg_3d, 
        colour = "p", text = "p"
        , 
        na.alpha= .5) %>% 
  add_glassbrain() %>%
  remove_axes() %>%
  pan_camera("left lateral")
```


Bayesian

```{r Bayesian}
#library(brms)
mod_put_int <- gam(cic_pos_ventral_put_harm ~ 1 + sex + visitnum_numeric  +
                 s(age, k = 3, fx = TRUE) +
                 s(mb_resid_z, k = 3, fx = TRUE) +
                 s(fss_resid_z, k = 3, fx = TRUE) +
                   s(id_fac, bs = "re"),
                 method = "REML",
                 data = full)
summary(mod_put_int)

a <- lmer(harox_putamen_harm ~ 1 + sex + visitnum_numeric + inv_age + fss_resid_z + mb_resid_z + (1|id), data = full, na.action = na.exclude)

#Do smooths differ at 18 years old between smooths?
plot(ggpredict(a, terms = c("fss_resid_z", "mb_resid_z")))
plot(q)
hypothesis_test(q)


mod_put_int1 <- gam(firststagestay ~ 1 + sex_p +
                 s(age, k = 5, fx = F) +
                   s(age, by = sex_p, k =5, fx = F) +
                   s(id_fac, bs = "re"),
                 method = "REML",
                 data = full[complete.cases(full),])
summary(mod_put_int1)
draw(mod_put_int1)
plot(ggpredict(mod_put_int1, terms = c("age", "sex"))) + geom_line(data = comp1, aes(x = ))
q <- derivatives(mod_put_int1)
draw(q)

plot(mod_put_int1)
pdat <- expand.grid(age = seq(10.17, 33.22, length = 400),
                    sex = c('F', 'M'))

xp <- predict(mod_put_int1, newdata = xp, type = 'lpmatrix')
#xp_dat <- as.data.frame(xp)

comp1 <- smooth_diff(mod_put_int1, pdat, "F", "M", "sex")

ggplot(comp1, aes(x = age, y = diff, group = pair)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2) +
    geom_line() +
    #facet_wrap(~ pair, ncol = 2) +
    #coord_cartesian(ylim = c(-30,30)) +
    labs(x = NULL, y = 'Difference in Hg trend')


mod_put_int <- brm(harox_putamen_harm ~ 1 + sex_p +
                 s(age, k = 5, fx = F) +
                   s(age, by = sex_p, k = 5, fx = F) +
                  s(id_fac, bs = "re"),
                 family = gaussian(), 
                 seed = 420,
                 iter = 4000,
                 warmup = 1000,
                 data = full[complete.cases(full),])
summary(mod_put_int)
plot(mod_put_int) #fuzzy caterpillar
fixef(mod_put_int) #Looking at fixed effects
plot(conditional_smooths(mod_put_int)) #Plotting the age smooth
pp_check(mod_put_int, ndraws = 100) #+ labs(x = "test")
conditional_smooths(mod_put_int)
plot(conditional_effects(mod_put_int))

plot(ggpredict(mod_put_int, terms = c("age", "sex_p")))
t <- derivatives(mod_put_int)

#Looking at posterior samples
post_samp <- posterior_samples(mod_put_int)




posterior_draws_df <- as.data.frame(post_samp)
q <- mod_put_int$fit@sim$samples


#Let's see if we can get posterior age effects
mcmc_plot(mod_put_int, variable = "sagesex_pFemale_1L", type = "hist")

#Looking at age.
full %>% add_predicted_draws(mod_put_int) %>%
  ggplot(aes(x = age, y = harox_putamen_harm)) +
  stat_lineribbon()
```

