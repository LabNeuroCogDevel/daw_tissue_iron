---
title: "daw_figures_072524"
author: "Daniel Petrie"
date: "2024-07-25"
output: html_document
editor_options: 
  chunk_output_type: console
---

WD/Libraries/data

```{r Global}
library("ggplot2") #For plotting
library("GGally") #ggpairs()
library("tidyverse") #Wranglin
library("dplyr") #Wranglin
library("interactions")
library("lme4") #MLM
library("lmerTest") #p-vals
library("ggeffects") #For marginal/conditional effects plots
library("marginaleffects") #For hypothesis_test()
library("parameters") #Other useful marginal effects functions
library("gdata") #upperTriangle()
library("mgcv") #GAMM
library("ggpubr") #Combining plots
library("bmlm") #Centering made easy
library("neuroCombat") #Harminization
library("LNCDR") #waterfall plot, lunaize plots 
library("gratia") #mgcv companion package. Using draw among other funcs.
library("psych") #Descriptives
library("ggrain") #Raincloud plot
library("ggseg") #Brain images
library("ggseg3d") #3d brain images
library("see") #Theme modern
library("viridis") #Additional colors
library("viridisLite") #Additional colors
library("ggnewscale") #new_scale()
#library("corrplot") #Corrplot()
#Working directory (change to something better (onedrive?, something else?) at some point)
#Hera feels correct at this moment. All files could live in directory R for this project.
setwd("C:/Users/djpet/OneDrive/Documents/daw_resting_state")
full <- read.csv("daw_project_081624.csv", header = TRUE)
```

11475 visit 2 should be removed.
11498 visit 2 should be removed.
11589 visit 2 should be removed.


Cleaning


```{r Cleaning}
#Creating a different sex variable for some plots/analyses
full <- full %>%
  mutate(sex = as.character(sex),
    sex_p = case_when(
    sex == "M" ~ "Male",
    sex == "F" ~ "Female",
    TRUE ~ sex 
  ))

#Making visitnum a factor. Can change accordingly
full$visitnum <- as.factor(full$visitnum)

#Making sex a factor
full$sex <- as.factor(full$sex)

#Making an ordered factor.
full$sex_p <- ordered(full$sex_p, levels = (c("Male", "Female")))

#Inverse age for linear models.
full$inv_age <- 1/full$age

#Checking for duplicate rows due to weird merging situation I put myself in.
full[which(duplicated(full$modelbased)),c(1:3, 8, 20)] #11475_2/11498_2/11589_2 are duplicates.
#These ids have duplicated Daw visits, but different rest days. Taking rows with imaging data.

full <- full %>%
  filter(!(id == "11475" & visitnum == "2") & 
           !(id == "11498" & visitnum == "2") &
           !(id == "11589" & visitnum == "2"))

#Treating visitnum as numeric?
full$visitnum_numeric <- as.numeric(full$visitnum)

#Treating id as factor for og gam fitting
full$id_fac <- as.factor(full$id)

#Age groups for plotting
full <- full %>%
  mutate(age_cat = cut(age,
                       breaks = c(10,13,17,24,34),
                       labels = c("10-13 years", "14-17 years", "18-24 years", "25-34 years"),
                       include.lowest = TRUE))
```


**Figure 1: Waterfall plot**
1)Waterfall plot (N subjects) (red + blue) (Same plot as puberty?)
(there will also be table 1 here)

**Figure 2: Task Image and Hypothesized MB/MF results**
2) (TOP): Daw Image
3) (Bottom): Hypothetical MB/MF

**Figure 3: Iron distributions and Age Iron Trajectories**
4) Raincould plot (Variability of tat2)
5) Age x tat2 plots

**Figure 4: Age Daw Trajectories**
6) Age x Daw plots

**Figure 5: Main Effect and Interaction plots**
8) After controlling for age, main effect of FSS and MB on putamen iron 

**Figure 6: Age x Daw Interactions**
9) age*mb interaction
10) age*fss interaction


**Supplementary Figures**

S1) Behavioral Results bar charts (in stay_probability script)
S2) Marginal effects from logistic regression model
S3) Sensitivity Iron Distributions and trajectories
S4) Posterior D/V Putamen interaction plots

**Waterfall plots**
Consider using theme_modern()

```{r Waterfall Plot}
age_ranked <- waterfall_group(full %>% 
                                dplyr::select(age, id, sex, study) %>%
                                filter(complete.cases(.)))

waterfall <- ggplot(data = age_ranked, 
               aes(x = age, y = age_id, group = age_id)) + 
  geom_line(aes(group = age_id, color = sex), alpha = .6) + 
  geom_point(aes(shape = sex, color=sex), alpha = .6) + 
  ylab("") + 
  xlab("Age (years)") + 
  theme_modern(base_size = 12) +
  theme(axis.title.y = element_blank(), 
        axis.ticks.y = element_blank(), 
        axis.text.y = element_blank(),
        axis.line.y = element_line(),
        legend.position=c(.15,.9), 
        legend.title=element_blank(), 
        axis.title.x = element_text(margin = margin(t = 10, 
                                                    r = 0, 
                                                    b = 0, 
                                                    l = 0)),
        panel.border = element_blank(),
        panel.grid.major = element_blank(), # Remove major grid lines
        panel.grid.minor = element_blank(),
        axis.line.x = element_line(),  # Increase x-axis line width
        axis.ticks.x = element_line(), # Increase x-axis ticks size
        axis.ticks.length = unit(0.2, "cm")) +  # Increase x-axis ticks length) + # Remove minor grid lines
  scale_color_manual(name = "Sex",
                     values = c("M" = "blue", "F" = "red"),
                     labels = c("M" = "Male", "F" = "Female")) + # Custom color labels
  scale_shape_manual(name = "Sex",
                     values = c("M" = 16, "F" = 17),
                     labels = c("M" = "Male", "F" = "Female"))
 
# Calculate table of sex counts for unique subject IDs
print(table(full$sex[match(unique(full$id), full$id)]))

#dev.new(width = 90, height = 70, unit = "mm", noRStudioGD=TRUE)

waterfall

#ggsave(filename = "manuscript_images/figure1.png", 
#       plot = waterfall, 
#       device = "png", 
#       dpi = 300, 
#       width = 90, 
#       height = 70, 
#       unit = "mm", 
#       scale = 1.5)
```



```{r iron raincloud and iron trajectories}
#Selecting harmonized tat2 variables to plot. I'll grab inverse as well.
tat2_harm_inv <- full %>% 
  dplyr::select("id", "study",
                "harox_pallidum_harm",
                "harox_nacc_harm",
                "harox_putamen_harm", 
                "harox_caudate_harm")

#Pivot longer for raincloud plot.
tat2_full_harm <- pivot_longer(tat2_harm_inv, 
                        cols = starts_with("harox"), 
                        names_to = "roi", 
                        values_to = "beta")

#Custom labels
custom_labels <- c("Ca", 
                   "NAcc",
                   "GP", 
                   "Pu")

#Rainclooud plot for whole sample
rain <- ggplot(tat2_full_harm %>% 
         filter(complete.cases(.)), aes(x = roi, 
                                        y = beta, 
                                        fill = roi)) + 
  geom_rain(alpha = .7,
            boxplot.args.pos = list(
              width = 0.05, position = position_nudge(x = 0.13)),
            violin.args.pos = list(
              side = "r",
              width = 0.7, position = position_nudge(x = 0.2))) +
  theme_modern(base_size = 14, axis.title.face = "plain") +
  scale_y_continuous(breaks = c(1.3, 1.2, 1.1, 1.0, 0.9, 
                                0.8, 0.7, 0.6, 0.5, 0.4), trans = "reverse") +
  scale_fill_brewer(palette = "Dark2") +
  guides(fill = "none", color = "none") +
  labs(x = "ROI", y = "nT2*w") +
  scale_x_discrete(labels = custom_labels) +
  theme(
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16)
  )
rain
#ggsave(filename = "flux_images/iron_test.pdf", plot = rain, width = 2.5, height = 2.5, dpi = 500)
#All plotted together over time
iron_long <- full %>%
  pivot_longer(cols = c(harox_pallidum_harm, 
                        harox_caudate_harm, 
                        harox_nacc_harm,
                        harox_putamen_harm),
               names_to = "outcome", 
               values_to = "value")
#All in the same plot. Weird because no stars for significance... need to figure that whole thing out.
#This could also be useful later on?
#Adding stars for significance
stars_df <- data.frame(
  x = c(33.2, 33.2, 33.2, 33.2),
  y = c(0.92, 0.83, 0.53, 0.80),
  outcome = c("Ca", "NAcc", "GP", "Pu"), # Outcomes
  star = c("***", "***", "***", "***"),
  angle = c(0, 0, 0, 0)# Significance stars
)

iron_age <- ggplot(data = iron_long, 
                   aes(x=age, y=value, colour = outcome)) + 
  geom_point(alpha = 0.5)+
  geom_line(aes(group = interaction(id, outcome)), alpha = 0.5) +
  theme_modern(base_size = 14, axis.title.face = "plain") + 
  scale_y_continuous(trans = "reverse") + 
  geom_smooth(method = "gam", 
              formula = y ~ s(x, bs = "tp"), 
              se = TRUE, 
              aes(group = outcome, 
                  fill = outcome),
              alpha = 0.6,
              linewidth = .8,
              color = "black") + 
  labs(x = "Age (years)", 
       y = "", 
       color = "ROI: ") + 
  scale_color_brewer(palette = "Dark2", 
                     labels = c("Ca", "NAcc", "GP", "Pu")) + 
  scale_fill_brewer(palette = "Dark2", 
                    labels = c("Ca", "NAcc", "GP", "Pu"), guide = FALSE) +
  theme(legend.position = "none", 
        strip.text = element_blank())  +
  theme(
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16)
  )

iron_age

ggarrange(rain, iron_age, 
          labels = c("A.", "B."),
          ncol = 2,
          nrow = 1, 
          legend = "none")
#ggsave(filename = "flux_images/daw_behave.png", plot = combined_plot, width = 12, height = 10, dpi = 300, units = "cm")
```


**Daw age trajectories**


```{r Daw age trajectories}
mb_age <- ggplot(data = full, 
               aes(x=age, y=modelbased_z, group = id)) + 
  geom_point(alpha = 0.7) +
  geom_line(alpha = 0.7) +
  theme_modern() +
  ylim(-3, 3) +
  stat_smooth(method = "gam",  aes(group = 1), color = "black", linewidth = 1) +
  labs(x = "Age (years)", y = "Parameter Estimate", title = "Model Based (z-scored)") +
  theme(legend.position = "bottom")  +
  geom_text(aes(x = 33.7, y = .5, 
                label = "***"), 
            size = 6,
            color = "black",
            angle = 90) +
    theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    plot.title = element_text(hjust = 0.5))
mb_age

mf_age <- ggplot(data = full, 
               aes(x=age, y=modelfree_z, group = id)) + 
  geom_point(alpha = 0.7) +
  geom_line(alpha = 0.7) +
  theme_modern() +
  ylim(-3, 3) +
  stat_smooth(method = "gam",  aes(group = 1), color = "black", linewidth = 1) +
  labs(x = "Age (years)", y = "", title = "Model Free (z-scored)") +
  theme(legend.position = "bottom")  +
  geom_text(aes(x = 33.7, y = .9, 
                label = "***"), 
            size = 6,
            color = "black",
            angle = 90) +
    theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    plot.title = element_text(hjust = 0.5))
mf_age

fss_age <- ggplot(data = full, 
               aes(x=age, y=firststagestay_z, group = id)) + 
  geom_point(alpha = 0.7) +
  geom_line(alpha = 0.7) +
  theme_modern() +
  ylim(-3, 3) +
  stat_smooth(method = "gam",  aes(group = 1), color = "black", linewidth = 1) +
  labs(x = "Age (years)", y = "", title = "First Stage Stay (z-scored)") +
  theme(legend.position = "bottom")  +
  geom_text(aes(x = 33.7, y = .95, 
                label = "***"), 
            size = 6,
            color = "black",
            angle = 90) +
    theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    plot.title = element_text(hjust = 0.5))
fss_age

#Combining
beh <- ggarrange(mb_age, mf_age, fss_age,
          labels = c("A.", "B.", "C."),
          ncol = 3,
          nrow = 1)
beh
#ggsave(filename = "flux_images/daw_trajectories.png", plot = beh, device = "png", dpi = 300, width = 190, height = 120, unit = "mm", scale = 1)
```

**Main effect plot**

I could potential plot both smooths on top of each other to show the opposite effects.

```{r Main effect plot}
test_5 <- gam(harox_putamen_harm ~ 1 + sex + visitnum_numeric + 
                       s(age, k = 3, fx = F) +
                 s(fss_resid_z, k = 3, fx = F) +
                 s(mb_resid_z, k = 3, fx = F)+
                     s(id_fac, bs = "re"),
                     method = "REML",
                     data = full)
summary(test_5)

#fss margins
mod_put_me_fss_margins <- ggpredict(test_5, 
                                     terms = c("fss_resid_z"))

#MB margins
mod_put_me_mb_margins <- ggpredict(test_5, 
                                     terms = c("mb_resid_z"))



#FSS and mb
p1 <- ggplot() +
  geom_point(data = full, 
             aes(x = fss_resid_z, 
                 y = harox_putamen_harm,
                 color = fss_resid_z),
             alpha = 0.5) + 
 # scale_color_viridis(option = "D", 
 #                     direction = -1, 
 #                     alpha = .7,
 #                     name = "FSS (z-scored)",
 #                     guide = guide_colorbar(position = "bottom")) +
  scale_color_gradient(name = "FSS", low = "blue", high = "red") +
    geom_smooth(data = mod_put_me_fss_margins,
              method = "gam",
              aes(x = x, 
                  y = predicted), 
              linewidth = 1.5,
              fullrange = T,
              #color = viridis(1, option = "D", direction = 1)
              color = "purple") +
  new_scale_color() + #Break here for new colors
  geom_point(data = full, 
            aes(x = mb_resid_z, 
                y = harox_putamen_harm, 
                color = mb_resid_z),
             alpha = 0.5) +
  #  scale_color_viridis(option = "C", 
  #                    direction = -1, 
  #                    alpha = .5,
  #                    name = "MB (z-scored)",
  #                    guide = guide_colorbar(position = "bottom")) +
  scale_color_gradient(name = "MB", low = "green", high = "orange") +
  geom_smooth(data = mod_put_me_mb_margins,
              method = "gam",
              aes(x = x, 
                  y = predicted), 
              linewidth = 1.5,
              fullrange = T,
              #color = viridis(1, option = "C", direction = -1)
              color = "lightgreen") +
   scale_y_continuous(trans = "reverse") +
  theme_modern(base_size = 12) +
  labs(x = "",
       y = "Putamen nT2*w") +
    theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12)
  )
  
p1

#FSS
p2 <- ggplot() +
  geom_point(data = full, 
             aes(x = fss_resid_z, 
                 y = harox_putamen_harm,
                 colour = age),
             alpha = 0.7) + 
    scale_color_viridis(option = "F", 
                      direction = -1, 
                      alpha = .7,
                      name = "Age",
                      guide = guide_colorbar(position = "bottom")) +
    geom_smooth(data = mod_put_me_fss_margins,
              method = "gam",
              aes(x = x, 
                  y = predicted,
                  colour = age), 
              linewidth = 1.2,
              alpha = 0.5,
              fullrange = T,
              color = "black") +
    geom_ribbon(data = mod_put_me_fss_margins, 
              aes(x = x, 
                  ymin = conf.low, 
                  ymax = conf.high), 
              fill = "gray70", 
              alpha = 0.3) +
  scale_y_continuous(trans = "reverse") +
  theme_modern(base_size = 12) +
  labs(x = "First Stage Stay (z-scored)",
       y = "Putamen nT2*w") +
    theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12)
  )
  
p2


#MB
p3 <- ggplot() +
  geom_point(data = full, 
             aes(x = mb_resid_z, 
                 y = harox_putamen_harm,
                 color = age),
             alpha = 0.5) + 
      scale_color_viridis(option = "F", 
                      direction = -1, 
                      alpha = .5,
                      name = "Age",
                      guide = guide_colorbar(position = "bottom")) +
    geom_smooth(data = mod_put_me_mb_margins,
              method = "gam",
              aes(x = x, 
                  y = predicted,
                  color = age), 
              linewidth = 1.5,
              fullrange = T,
              color = "black") +
     scale_y_continuous(trans = "reverse") +
  theme_modern(base_size = 12) +
  labs(x = "Model Based (z-scored)",
       y = "") +
    theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12)
  )
  
p3


beh_iron <- ggarrange(p2, p3,
          labels = c("A.", "B."),
          ncol = 2,
          nrow = 1)
beh_iron
```


Interactions of interest. The idea is that we want to see whether these reinforcement learning parameters differentially relate the trajectories of the iron measures.


```{r s(Age):FSS Model}
mod_put_int <- gam(harox_putamen_harm ~ 1 + sex + visitnum_numeric  + 
                 s(age, k = 3, fx = F) +
                 s(age, by = mb_resid_z, k = 3, fx = F) +
                 s(age, by = fss_resid_z, k = 3, fx = F) +
                   s(id_fac, bs = "re"),
                 method = "REML",
                 data = full)
summary(mod_put_int)
#draw(mod_put_int)
mod_put_test <- gam(harox_putamen_harm ~ 1 + sex + visitnum_numeric  + 
                 s(age, k = 3, fx = F) +
                 s(age, by = modelbased, k = 3, fx = F) +
                 s(age, by = firststagestay, k = 3, fx = F) +
                   s(id_fac, bs = "re"),
                 method = "REML",
                 data = full)
summary(mod_put_test)
#fss margins
mod_put_int_fss_margins <- ggpredict(mod_put_int, 
                                     terms = c("age", "fss_resid_z[-2,-1,0,1,2]"))

#MB margins
mod_put_int_mb_margins <- ggpredict(mod_put_int, 
                                     terms = c("age", "mb_resid_z[-2,-1,0,1,2]"))



```

Derivatives to add to plots. My current take is that this plot is literally identical to the J/N plot (because they are!). I think I like the approach where you show simple slopes, and they add the region of sig with geom_vline.

```{r Derivatives}
#Extract derivatives
d <- derivatives(mod_put_int, 
                 n = 200)
#Plot derivatives
draw(d)

#Calculate regions of significance, where CI != 0
d <- d %>% mutate(sig = !(0>.lower_ci & 0<.upper_ci))

#Split data into s(age) and s(age):FSS
d_age <- d %>% slice(1:200)
d_age_mb <- d %>% slice(201:400)
d_age_fss <- d %>% slice(401:600)
#Range of significane for age
cat(sprintf(
  "\nSignificant change: %1.2f - %1.2f\n",
  min(d_age$age[d_age$sig==T]),
  max(d_age$age[d_age$sig==T]))) 

#Age range of significance for Age:MB
cat(sprintf(
  "\nSignificant change: %1.2f - %1.2f\n",
  min(d_age_mb$age[d_age_mb$sig==T]),
  max(d_age_mb$age[d_age_mb$sig==T]))) 

#Age range of significance for Age:FSS
cat(sprintf(
  "\nSignificant change: %1.2f - %1.2f\n",
  min(d_age_fss$age[d_age_fss$sig==T]),
  max(d_age_fss$age[d_age_fss$sig==T])))

#ggplot(data = d_age_fss,aes(x=age,y = .derivative, color=sig, ymin=.lower_ci,ymax=.upper_ci)) + #geom_ribbon(fill="black",alpha=.3,color=NA) + geom_line(size=1,show.legend = F) +scale_color_manual(values = c("TRUE" #= "firebrick","FALSE" = "black")) + geom_hline(yintercept = 0,linetype=2) + scale_y_continuous(transform = "reverse")
```



```{r Interaction figures}
#age:fss viridis "D"
p1 <- ggplot() +
  geom_point(data = full, 
             aes(x = age, 
                 y = harox_putamen_harm, 
                 color = fss_resid_z, 
                 group = id)) + 
  geom_line(data = full, 
            aes(x = age, 
                y = harox_putamen_harm, 
                color = fss_resid_z, 
                group = id)) +
  scale_color_viridis(option = "D", 
                      direction = -1, 
                      alpha = .5,
                      name = "FSS (z-scored)",
                      guide = guide_colorbar(position = "bottom")) +
  scale_fill_viridis(option = "D", 
                     direction = -1, 
                     alpha = .5) +
  new_scale_color() +
  new_scale_fill() +
  geom_smooth(data = mod_put_int_fss_margins, 
              aes(x = x, 
                  y = predicted, 
                  group = group, 
                  color = group),
              method = "gam",
              linewidth = 1.5) +
  scale_color_viridis(discrete = TRUE, 
                      option = "D",
                      direction = -1, 
                      guide = "none") + 
  scale_y_continuous(trans = "reverse") +
  labs(title = "Age x FSS Interaction",
       x = "Age (years)",
       y = "Putamen nT2*w") + 
  theme_modern(base_size = 12) +
  geom_text(aes(x = 29, y = 1.1), 
            label = expression("s(Age):FSS " * italic(F) * " = 4.55, " * italic(p) * " = 0.01"),
            size = 4, 
            color = "black") +
  geom_text(aes(x = 21.72, y = 0.7),
            label = "p < 0.05",
            size = 4,
            color = "black") +
   geom_text(aes(x = 25.72, y = 0.7),
            label = "n.s.",
            size = 4,
            color = "black") +
  theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    plot.title = element_text(hjust = 0.5)) +
  geom_vline(xintercept = 23.72, 
             linetype = "dashed", 
             color = "black", 
             linewidth = 1)
p1

#age:MB plasma "C"
p2 <- ggplot() +
  geom_point(data = full, 
             aes(x = age, 
                 y = harox_putamen_harm, 
                 color = mb_resid_z, 
                 group = id)) + 
  geom_line(data = full, 
            aes(x = age, 
                y = harox_putamen_harm, 
                color = mb_resid_z, 
                group = id)) +
  scale_color_viridis(option = "C", 
                      direction = -1, 
                      alpha = .5,
                      name = "MB (z-scored)",
                      guide = guide_colorbar(position = "bottom")) +
  scale_fill_viridis(option = "C", 
                     direction = -1, 
                     alpha = .5) +
  new_scale_color() +
  new_scale_fill() +
  geom_smooth(data = mod_put_int_mb_margins, 
              aes(x = x, 
                  y = predicted, 
                  group = group, 
                  color = group), 
              size = 1.5) +
  #geom_ribbon(data = mod_put_int_mb_margins, 
  #            aes(x = x, 
  #                ymin = conf.low, 
  #                ymax = conf.high, 
  #                fill = group), 
  #            alpha = 0.2) +
  scale_color_viridis(discrete = TRUE, 
                      option = "C", 
                      direction = -1, 
                      guide = "none") + 
  #scale_fill_viridis(discrete = TRUE, 
  #                   option = "C", 
  #                   direction = -1, 
  #                   guide = "none") +
  scale_y_continuous(trans = "reverse") +
  labs(title = "Age x MB Interaction",
       x = "Age (years)",
       y = "Putamen nT2*w") + 
  theme_modern() +
  geom_text(aes(x = 29, y = 1.1), 
            label = expression("s(Age):MB " * italic(F) * " = 5.07, " * italic(p) * " = 0.007"),
            size = 4, 
            color = "black") +
  geom_text(aes(x = 19.40, y = 0.7),
            label = "p < 0.05",
            size = 4,
            color = "black") +
   geom_text(aes(x = 23.40, y = 0.7),
            label = "n.s.",
            size = 4,
            color = "black") +
  theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    plot.title = element_text(hjust = 0.5)) +
  geom_vline(xintercept = 21.40, 
             linetype = "dashed", 
             color = "black", 
             linewidth = 1)
p2
q3 <- ggarrange(p1, p2,
          labels = c("A.", "B."),
          ncol = 2,
          nrow = 1, 
          common.legend = FALSE, 
          legend = "bottom")
q3
#dev.new(width = 190, height = 140, unit = "mm", noRStudioGD=TRUE)
#ggsave(filename = "flux_images/interaction_test3.png", plot = q3, device = "png", dpi = 300, width = 220, height = 140, unit = "mm", scale = 1.5)
#This looks to be close to the right dimensions? Scaling looks like it could be appropriate? 
```

**Sensitivity Models**

```{r Sensitivity s(age):FSS models}
#post dorsal put
sensitivity_pos_dputamen <- gam(cic_pos_dorsal_put_harm ~ 1 + sex + visitnum_numeric + 
                       s(age, k = 3, fx = F) +
                s(age, by = fss_resid_z, k = 3, fx = F) +
                s(age, by = mb_resid_z, k = 3, fx = F) +
                s(id_fac, bs = "re"),
                     method = "REML",
                     data = full)


summary(sensitivity_pos_dputamen)
#Plots for viewing fast
#plot(ggpredict(sensitivity_pos_dputamen, 
#               terms = c("age", "mb_resid_z[-2,2]"))) + scale_y_continuous(trans = "reverse")
#plot(ggpredict(sensitivity_pos_dputamen, 
#               terms = c("age", "fss_resid_z[-2,2]"))) + scale_y_continuous(trans = "reverse")
pos_dput_int_fss_margins <- ggpredict(sensitivity_pos_dputamen, 
                                      terms = c("age", "fss_resid_z[-2,-1,0,1,2]"))

pos_dput_int_mb_margins <- ggpredict(sensitivity_pos_dputamen, 
                                      terms = c("age", "mb_resid_z[-2,-1,0,1,2]"))


#post ventral put
sensitivity_pos_vputamen <- gam(cic_pos_ventral_put_harm ~ 1 + sex + visitnum_numeric + 
                       s(age, k = 3, fx = F) +
                s(age, by = fss_resid_z, k = 3, fx = F) +
                s(age, by = mb_resid_z, k = 3, fx = F) +
                s(id_fac, bs = "re"),
                     method = "REML",
                     data = full)

#summary(test_2$gam)
summary(sensitivity_pos_vputamen)
#plot(ggpredict(sensitivity_pos_vputamen, 
#               terms = c("age", "mb_resid_z[-2,2]"))) + scale_y_continuous(trans = "reverse")
#plot(ggpredict(sensitivity_pos_vputamen, 
#               terms = c("age", "fss_resid_z[-2,2]"))) + scale_y_continuous(trans = "reverse")
pos_vput_int_fss_margins <- ggpredict(sensitivity_pos_vputamen, 
                                      terms = c("age", "fss_resid_z[-2,-1,0,1,2]"))

pos_vput_int_mb_margins <- ggpredict(sensitivity_pos_vputamen, 
                                      terms = c("age", "mb_resid_z[-2,-1,0,1,2]"))
```


**Sensitivity derivatives**

```{r Sensitivity Derivatives}
#Extract derivatives
dorsal <- derivatives(sensitivity_pos_dputamen, 
                 n = 200)
#Plot derivatives
draw(dorsal)

#Calculate regions of significance, where CI != 0
dorsal <- dorsal %>% mutate(sig = !(0>.lower_ci & 0<.upper_ci))

#Split data into s(age) and s(age):FSS
dorsal_age <- dorsal %>% slice(1:200)
dorsal_age_fss <- dorsal %>% slice(201:400)
dorsal_age_mb <- dorsal %>% slice(401:600)
#Range of significane for age
cat(sprintf(
  "\nSignificant change: %1.2f - %1.2f\n",
  min(dorsal_age$age[dorsal_age$sig==T]),
  max(dorsal_age$age[dorsal_age$sig==T]))) 

#Age range of significance for Age:MB
cat(sprintf(
  "\nSignificant change: %1.2f - %1.2f\n",
  min(dorsal_age_mb$age[dorsal_age_mb$sig==T]),
  max(dorsal_age_mb$age[dorsal_age_mb$sig==T]))) 

#Age range of significance for Age:FSS
cat(sprintf(
  "\nSignificant change: %1.2f - %1.2f\n",
  min(dorsal_age_fss$age[dorsal_age_fss$sig==T]),
  max(dorsal_age_fss$age[dorsal_age_fss$sig==T])))

#ggplot(data = d_age_fss,aes(x=age,y = .derivative, color=sig, ymin=.lower_ci,ymax=.upper_ci)) + #geom_ribbon(fill="black",alpha=.3,color=NA) + geom_line(size=1,show.legend = F) +scale_color_manual(values = c("TRUE" #= "firebrick","FALSE" = "black")) + geom_hline(yintercept = 0,linetype=2) + scale_y_continuous(transform = "reverse")

#Extract derivatives
ventral <- derivatives(sensitivity_pos_vputamen, 
                 n = 200)
#Plot derivatives
draw(ventral)

#Calculate regions of significance, where CI != 0
ventral <- ventral %>% mutate(sig = !(0>.lower_ci & 0<.upper_ci))

#Split data into s(age) and s(age):FSS
ventral_age <- ventral %>% slice(1:200)
ventral_age_fss <- ventral %>% slice(201:400)
ventral_age_mb <- ventral %>% slice(401:600)
#Range of significane for age
cat(sprintf(
  "\nSignificant change: %1.2f - %1.2f\n",
  min(ventral_age$age[ventral_age$sig==T]),
  max(ventral_age$age[ventral_age$sig==T]))) 

#Age range of significance for Age:MB
cat(sprintf(
  "\nSignificant change: %1.2f - %1.2f\n",
  min(ventral_age_mb$age[ventral_age_mb$sig==T]),
  max(ventral_age_mb$age[ventral_age_mb$sig==T]))) 

#Age range of significance for Age:FSS
cat(sprintf(
  "\nSignificant change: %1.2f - %1.2f\n",
  min(ventral_age_fss$age[ventral_age_fss$sig==T]),
  max(ventral_age_fss$age[ventral_age_fss$sig==T])))

#ggplot(data = d_age_fss,aes(x=age,y = .derivative, color=sig, ymin=.lower_ci,ymax=.upper_ci)) + #geom_ribbon(fill="black",alpha=.3,color=NA) + geom_line(size=1,show.legend = F) +scale_color_manual(values = c("TRUE" #= "firebrick","FALSE" = "black")) + geom_hline(yintercept = 0,linetype=2) + scale_y_continuous(transform = "reverse")
```

**Sensitivity plots**
4 of these...
alpha and n.s. parts are two away.

```{r Sensitivity Plots}
#pos dorsal put age:fss mako "G"
p3 <- ggplot() +
  geom_point(data = full, 
             aes(x = age, 
                 y = cic_pos_dorsal_put_harm, 
                 color = fss_resid_z, 
                 group = id)) + 
  geom_line(data = full, 
            aes(x = age, 
                y = cic_pos_dorsal_put_harm, 
                color = fss_resid_z, 
                group = id)) +
  scale_color_viridis(option = "G", 
                      direction = -1, 
                      alpha = .5,
                      name = "FSS (z-scored)",
                      guide = guide_colorbar(position = "bottom")) +
  scale_fill_viridis(option = "G", 
                     direction = -1, 
                     alpha = .5) +
  new_scale_color() +
  new_scale_fill() +
  geom_smooth(data = pos_dput_int_fss_margins, 
              aes(x = x, 
                  y = predicted, 
                  group = group, 
                  color = group), 
              linewidth = 1.5) +
  scale_color_viridis(discrete = TRUE, 
                      option = "G",
                      direction = -1, 
                      guide = "none") + 
  scale_y_continuous(trans = "reverse") +
  labs(title = "Age x FSS Interaction",
       x = "Age (years)",
       y = "PD Putamen nT2*w") + 
  theme_modern(base_size = 16) +
 # geom_text(aes(x = 28, y = 1.1), 
 #           label = expression("s(Age):FSS " * italic(F) * " = 3.46, " * italic(p) * " = 0.02"),
 #           size = 3.5, 
 #           color = "black") +
  geom_text(aes(x = 16.97, y = 0.7),
            label = "p < 0.05",
            size = 4,
            color = "black") +
   geom_text(aes(x = 20.97, y = 0.7),
            label = "n.s.",
            size = 4,
            color = "black") +
  theme(
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    plot.title = element_text(hjust = 0.5)) +
  geom_vline(xintercept = 18.97, 
             linetype = "dashed", 
             color = "black", 
             linewidth = 1)
p3

#pos dorsal put age:mb rocket "F"
p4 <- ggplot() +
  geom_point(data = full, 
             aes(x = age, 
                 y = cic_pos_dorsal_put_harm, 
                 color = mb_resid_z, 
                 group = id)) + 
  geom_line(data = full, 
            aes(x = age, 
                y = cic_pos_dorsal_put_harm, 
                color = mb_resid_z, 
                group = id)) +
  scale_color_viridis(option = "F", 
                      direction = -1, 
                      alpha = .5,
                      name = "MB (z-scored)",
                      guide = guide_colorbar(position = "bottom")) +
  scale_fill_viridis(option = "F", 
                     direction = -1, 
                     alpha = .5) +
  new_scale_color() +
  new_scale_fill() +
  geom_smooth(data = pos_dput_int_mb_margins, 
              aes(x = x, 
                  y = predicted, 
                  group = group, 
                  color = group), 
              linewidth = 1.5) +
  scale_color_viridis(discrete = TRUE, 
                      option = "F",
                      direction = -1, 
                      guide = "none") + 
  scale_y_continuous(trans = "reverse") +
  labs(title = "Age x MB Interaction",
       x = "Age (years)",
       y = "PD Putamen nT2*w") + 
  theme_modern(base_size = 16) +
  #geom_text(aes(x = 24.5, y = 1.1), 
  #          label = expression("s(Age):MB " * italic(F) * " = 7.33, " * italic(p) * " < 0.001"),
  #          size = 3.5, 
  #          color = "black") +
  geom_text(aes(x = 18.36, y = 0.65),
            label = "p < 0.05",
            size = 4,
            color = "black") +
   geom_text(aes(x = 24, y = 0.65),
            label = "n.s.",
            size = 4,
            color = "black") +
     geom_text(aes(x = 30.36, y = 0.65),
            label = "p < 0.05",
            size = 4,
            color = "black") +
  theme(
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    plot.title = element_text(hjust = 0.5)) +
  geom_vline(xintercept = 20.36, 
             linetype = "dashed", 
             color = "black", 
             linewidth = 1) +
  geom_vline(xintercept = 28.35, 
             linetype = "dashed", 
             color = "black", 
             linewidth = 1)
p4


#pos ventral put age:fss mako "G"
#Need to adjust geom_text layers
#Also something looks weird
p5 <- ggplot() +
  geom_point(data = full, 
             aes(x = age, 
                 y = cic_pos_ventral_put_harm, 
                 color = fss_resid_z, 
                 group = id)) + 
  geom_line(data = full, 
            aes(x = age, 
                y = cic_pos_ventral_put_harm, 
                color = fss_resid_z, 
                group = id)) +
  scale_color_viridis(option = "G", 
                      direction = -1, 
                      alpha = .5,
                      name = "FSS (z-scored)",
                      guide = guide_colorbar(position = "bottom")) +
  scale_fill_viridis(option = "G", 
                     direction = -1, 
                     alpha = .5) +
  new_scale_color() +
  new_scale_fill() +
  geom_smooth(data = pos_vput_int_fss_margins, 
              aes(x = x, 
                  y = predicted, 
                  group = group, 
                  color = group), 
              linewidth = 1.5) +
  scale_color_viridis(discrete = TRUE, 
                      option = "G",
                      direction = -1, 
                      guide = "none") + 
  scale_y_continuous(trans = "reverse") +
  labs(title = "Age x FSS Interaction",
       x = "Age (years)",
       y = "PV Putamen nT2*w") + 
  theme_modern(base_size = 16) +
  #geom_text(aes(x = 28, y = 1.21), 
  #          label = expression("s(Age):FSS " * italic(F) * " = 3.75, " * italic(p) * " = 0.013"),
  #          size = 3.5, 
  #          color = "black") +
  geom_text(aes(x = 15.23, y = 0.63),
            label = "p < 0.05",
            size = 4,
            color = "black") +
   geom_text(aes(x = 19.23, y = 0.63),
            label = "n.s.",
            size = 4,
            color = "black") +
  theme(
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    plot.title = element_text(hjust = 0.5)) +
  geom_vline(xintercept = 17.23, 
             linetype = "dashed", 
             color = "black", 
             linewidth = 1)
p5

#pos dorsal put age:mb rocket "F"
p6 <- ggplot() +
  geom_point(data = full, 
             aes(x = age, 
                 y = cic_pos_ventral_put_harm, 
                 color = mb_resid_z, 
                 group = id)) + 
  geom_line(data = full, 
            aes(x = age, 
                y = cic_pos_ventral_put_harm, 
                color = mb_resid_z, 
                group = id)) +
  scale_color_viridis(option = "F", 
                      direction = -1, 
                      alpha = .5,
                      name = "MB (z-scored)",
                      guide = guide_colorbar(position = "bottom")) +
  scale_fill_viridis(option = "F", 
                     direction = -1, 
                     alpha = .5) +
  new_scale_color() +
  new_scale_fill() +
  geom_smooth(data = pos_vput_int_mb_margins, 
              aes(x = x, 
                  y = predicted, 
                  group = group, 
                  color = group), 
              linewidth = 1.5) +
  scale_color_viridis(discrete = TRUE, 
                      option = "F",
                      direction = -1, 
                      guide = "none") + 
  scale_y_continuous(trans = "reverse") +
  labs(title = "Age x MB Interaction",
       x = "Age (years)",
       y = "PV Putamen nT2*w") + 
  theme_modern(base_size = 16) +
  #geom_text(aes(x = 28, y = 1.21), 
  #          label = expression("s(Age):MB " * italic(F) * " = 4.73, " * italic(p) * " = 0.01"),
  #          size = 3.5, 
  #          color = "black") +
  geom_text(aes(x = 18.82, y = 0.63),
            label = "p < 0.05",
            size = 4,
            color = "black") +
   geom_text(aes(x = 22.82, y = 0.63),
            label = "n.s.",
            size = 4,
            color = "black") +
  theme(
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    plot.title = element_text(hjust = 0.5)) +
  geom_vline(xintercept = 20.82, 
             linetype = "dashed", 
             color = "black", 
             linewidth = 1)
p6

q4 <- ggarrange(p3,p4,p5,p6, 
          labels = c("A.", "B.", "C.", "D."),
          ncol = 2,
          nrow = 2, 
          common.legend = FALSE, 
          legend = "bottom")
q4
#This actually sorta works?
#ggsave(filename = "flux_images/sense_interactionstesttest.png", plot = q4, device = "png", dpi = 500, width = 190, height = 140, unit = "mm", scale = 1.5)
```


**Sensitivity Atlas Iron distributions**

I need to subset full and grab id, age, visit, scanner and cic variables 

```{r Sensitivity Iron Distributions}
#Using grep to select columns I want.
columns_to_select <- grep("^(?!.*_z).*cic.*harm|harm.*cic", 
                          names(full), 
                          value = TRUE, 
                          perl = TRUE)

#Subsetting
tat2_full_harm <- full %>%
  select(id, visitnum, age, sex, study, all_of(columns_to_select))
#Pivot longer for raincloud plot.
tat2_full_long_harm <- pivot_longer(tat2_full_harm, 
                        cols = starts_with("cic"), 
                        names_to = "roi", 
                        values_to = "beta")

custom_labels <- c("PD Putamen", 
                   "PV Putamen",
                   "AD Putamen", 
                   "AV Putamen")

#Rainclooud plot for whole sample
rain <- ggplot(tat2_full_long_harm %>%
                 filter(roi == c("cic_pre_dorsal_put_harm", 
                        "cic_pre_ventral_put_harm", 
                        "cic_pos_dorsal_put_harm", 
                        "cic_pos_ventral_put_harm")) %>% 
                 filter(complete.cases(.)), aes(x = roi, 
                                                y = beta, 
                                                fill = roi)) + 
  geom_rain(alpha = .7,
            boxplot.args.pos = list(
              width = 0.05, position = position_nudge(x = 0.13)),
            violin.args.pos = list(
              side = "r",
              width = 0.7, position = position_nudge(x = 0.2))) +
  theme_modern(base_size = 16, axis.title.face = "plain") +
  scale_y_continuous(breaks = c(1.3, 1.2, 1.1, 1.0, 0.9, 
                                0.8, 0.7, 0.6, 0.5, 0.4), trans = "reverse") +
  scale_fill_brewer(palette = "Dark2") +
  guides(fill = "none", color = "none") +
  labs(x = "ROI", y = "nT2*w") +
  scale_x_discrete(labels = custom_labels) +
  theme(
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    axis.text.x = element_blank(),
    axis.text.y = element_text(size = 16)
  )
rain

#Trajectories
iron_age <- ggplot(data = tat2_full_long_harm %>%
                 filter(roi == c("cic_pre_dorsal_put_harm", 
                        "cic_pre_ventral_put_harm", 
                        "cic_pos_dorsal_put_harm", 
                        "cic_pos_ventral_put_harm")) %>% 
                 filter(complete.cases(.)), 
                   aes(x=age, y=beta, colour = roi)) + 
  geom_point(alpha = 0.5)+
  geom_line(aes(group = interaction(id, roi)), alpha = 0.5) +
  theme_modern(base_size = 16) + 
  scale_y_continuous(trans = "reverse") + 
  geom_smooth(method = "gam", 
              formula = y ~ s(x, bs = "tp"), 
              se = TRUE, 
              aes(group = roi, 
                  fill = roi),
              alpha = 0.6,
              linewidth = .8,
              color = "black") + 
  labs(x = "Age (years)", 
       y = "", 
       color = "ROI: ") + 
  scale_color_brewer(palette = "Dark2", 
                     labels = custom_labels) + 
  scale_fill_brewer(palette = "Dark2", 
                    labels = custom_labels, guide = FALSE) +
  theme(#legend.position = "none", 
        strip.text = element_blank())  +
  theme(
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16)
  ) + facet_wrap(~roi)

iron_age

q5 <- ggarrange(rain, iron_age, 
          labels = c("A.", "B."),
          ncol = 2,
          nrow = 1, 
          common.legend = TRUE, 
          legend = "bottom") #Maybe top instead?
q5
ggsave(filename = "flux_images/sense_iront.png", 
       plot = q5, device = "png", 
       dpi = 500, width = 190, height = 120, unit = "mm", scale = 1.5)
```


Comparing perseverance parameter and FSS. Not sure if this would be in supplement or not...

```{r Bivariate pi x FSS}
#pi checks
#Harox putamen: not sig in TV model. AS main effect, trending signficance.
#cic_pos_ventral_put_harm: trending sig in TV model, AS main effect, not sig. 
#cic_pos_dorsal_put_harm: Not sig in TV model, As main effect, not sig. 
sensitivity_put_pi <- gam(cic_pos_dorsal_put_harm ~ 1 + sex + visitnum_numeric + 
                       s(age, k = 3, fx = F) +
                s(pi_z, k = 3, fx = F) +
                  ti(age,pi_z, k = 3, fx = F) +
                  #s(age, by = w_z, k = 3, fx = F) +
                s(id_fac, bs = "re"),
                     method = "REML",
                     data = full)

summary(sensitivity_put_pi)
plot(ggpredict(sensitivity_put_pi, 
               terms = c("age", "pi_z[-2,2]"))) + scale_y_continuous(trans = "reverse")

#Correlation for plot.
cor(full$pi, full$firststagestay)
#plot of bivariate association between pi and FSS.
biv_habit <- ggplot(full, aes(x = pi, y = firststagestay)) + 
  geom_point(alpha = 0.5) + 
  geom_smooth(method = "gam", 
              linewidth = 1.5,
              fullrange = T,
              color = "black") +
  theme_modern(base_size = 12) +
  labs(x = "Perseverance",
       y = "First stage stay",
       title = "Bivariate Association") +
   geom_text(aes(x = 2.5, y = -1.5),
            label = "r = 0.91",
            size = 4,
            color = "black") +
    theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    plot.title = element_text(hjust = 0.5)
  )
biv_habit

#Seeing if other Daw parameters correlate the same way.
cor(full$pi, full$modelbased)
biv_mb <- ggplot(full, aes(x = pi, y = modelbased)) + 
  geom_point(alpha = 0.5) + 
  geom_smooth(method = "gam", 
              linewidth = 1.5,
              fullrange = T,
              color = "black") +
  theme_modern(base_size = 12) +
  labs(x = "Perseverance (pi)",
       y = "Model Based") +
   geom_text(aes(x = 2.5, y = -1.5),
            label = "r = 0.54",
            size = 4,
            color = "black") +
    theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12)
  )
biv_mb


cor(full$pi, full$modelfree)
biv_mf <- ggplot(full, aes(x = pi, y = modelfree)) + 
  geom_point(alpha = 0.5) + 
  geom_smooth(method = "gam", 
              linewidth = 1.5,
              fullrange = T,
              color = "black") +
  theme_modern(base_size = 12) +
  labs(x = "Perseverance (pi)",
       y = "Model Free") +
   geom_text(aes(x = 2.5, y = -1.5),
            label = "r = 0.55",
            size = 4,
            color = "black") +
    theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12)
  )
biv_mf


lambda <- ggplot(full, aes(x = age, y = lambda)) + 
  geom_point(alpha = 0.5) + 
  geom_smooth(method = "gam", 
              linewidth = 1.5,
              fullrange = T,
              color = "black") +
  theme_modern(base_size = 12) +
  labs(x = "Perseverance (pi)",
       y = "Model Free") +
    theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12)
  )
lambda

pi_age <- ggplot(data = full, 
               aes(x=age, y=pi_z, group = id)) + 
  geom_point(alpha = 0.7) +
  geom_line(alpha = 0.7) +
  theme_modern() +
  #ylim(-3, 3) +
  stat_smooth(method = "gam",  aes(group = 1), color = "black", linewidth = 1) +
  labs(x = "Age (years)", y = "Parameter Estimate", title = "Perseverance (z-scored)") +
  theme(legend.position = "bottom")  +
  #geom_text(aes(x = 33.7, y = .5, 
  #              label = "***"), 
  #          size = 6,
  #          color = "black",
  #          angle = 90) +
    theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    plot.title = element_text(hjust = 0.5))
pi_age

fss_age <- ggplot(data = full, 
               aes(x=age, y=firststagestay_z, group = id)) + 
  geom_point(alpha = 0.7) +
  geom_line(alpha = 0.7) +
  theme_modern() +
  ylim(-3, 3) +
  stat_smooth(method = "gam",  aes(group = 1), color = "black", linewidth = 1) +
  labs(x = "Age (years)", y = "Parameter Estimate", title = "First Stage Stay (z-scored)") +
  theme(legend.position = "bottom")  +
  #geom_text(aes(x = 33.7, y = .95, 
  #              label = "***"), 
  #          size = 6,
  #          color = "black",
  #          angle = 90) +
    theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    plot.title = element_text(hjust = 0.5))
fss_age

fss_ppi <- ggarrange(biv_habit, pi_age, fss_age,
                     labels = c("A.", "B.", "C."), 
                     ncol = 3, 
                     nrow = 1)
fss_ppi

t <- ggarrange(biv_habit, pi_age,
                     labels = c("A.", "B."), 
                     ncol = 2, 
                     nrow = 1)
t
```


Alternative figures based on white board meeting.


**Sensitivity Models JUST HABITS**

```{r Sensitivity s(age):FSS models JUST HABITS}
#pre dorsal put
sensitivity_pre_dputamen <- gam(cic_pre_dorsal_put_harm ~ 1 + sex + visitnum_numeric + 
                       s(age, k = 3, fx = F) +
                s(age, by = fss_resid_z, k = 3, fx = F) +
                s(age, by = mb_resid_z, k = 3, fx = F) +
                s(id_fac, bs = "re"),
                     method = "REML",
                     data = full)


summary(sensitivity_pre_dputamen)
#Plots for viewing fast
#plot(ggpredict(sensitivity_pos_dputamen, 
#               terms = c("age", "mb_resid_z[-2,2]"))) + scale_y_continuous(trans = "reverse")
#plot(ggpredict(sensitivity_pos_dputamen, 
#               terms = c("age", "fss_resid_z[-2,2]"))) + scale_y_continuous(trans = "reverse")
pre_dput_int_fss_margins <- ggpredict(sensitivity_pre_dputamen, 
                                      terms = c("age", "fss_resid_z[-2,-1,0,1,2]"))

pre_dput_int_mb_margins <- ggpredict(sensitivity_pre_dputamen, 
                                      terms = c("age", "mb_resid_z[-2,-1,0,1,2]"))


#pre ventral put
sensitivity_pre_vputamen <- gam(cic_pre_ventral_put_harm ~ 1 + sex + visitnum_numeric + 
                       s(age, k = 3, fx = F) +
                s(age, by = fss_resid_z, k = 3, fx = F) +
                s(age, by = mb_resid_z, k = 3, fx = F) +
                s(id_fac, bs = "re"),
                     method = "REML",
                     data = full)

#summary(test_2$gam)
summary(sensitivity_pre_vputamen)
#plot(ggpredict(sensitivity_pos_vputamen, 
#               terms = c("age", "mb_resid_z[-2,2]"))) + scale_y_continuous(trans = "reverse")
#plot(ggpredict(sensitivity_pos_vputamen, 
#               terms = c("age", "fss_resid_z[-2,2]"))) + scale_y_continuous(trans = "reverse")
pre_vput_int_fss_margins <- ggpredict(sensitivity_pre_vputamen, 
                                      terms = c("age", "fss_resid_z[-2,-1,0,1,2]"))

pre_vput_int_mb_margins <- ggpredict(sensitivity_pre_vputamen, 
                                      terms = c("age", "mb_resid_z[-2,-1,0,1,2]"))
#post dorsal put
sensitivity_pos_dputamen <- gam(cic_pos_dorsal_put_harm ~ 1 + sex + visitnum_numeric + 
                       s(age, k = 3, fx = F) +
                s(age, by = fss_resid_z, k = 3, fx = F) +
                s(age, by = mb_resid_z, k = 3, fx = F) +
                s(id_fac, bs = "re"),
                     method = "REML",
                     data = full)


summary(sensitivity_pos_dputamen)
#Plots for viewing fast
#plot(ggpredict(sensitivity_pos_dputamen, 
#               terms = c("age", "mb_resid_z[-2,2]"))) + scale_y_continuous(trans = "reverse")
#plot(ggpredict(sensitivity_pos_dputamen, 
#               terms = c("age", "fss_resid_z[-2,2]"))) + scale_y_continuous(trans = "reverse")
pos_dput_int_fss_margins <- ggpredict(sensitivity_pos_dputamen, 
                                      terms = c("age", "fss_resid_z[-2,-1,0,1,2]"))

pos_dput_int_mb_margins <- ggpredict(sensitivity_pos_dputamen, 
                                      terms = c("age", "mb_resid_z[-2,-1,0,1,2]"))


#post ventral put
sensitivity_pos_vputamen <- gam(cic_pos_ventral_put_harm ~ 1 + sex + visitnum_numeric + 
                       s(age, k = 3, fx = F) +
                s(age, by = fss_resid_z, k = 3, fx = F) +
                s(age, by = mb_resid_z, k = 3, fx = F) +
                s(id_fac, bs = "re"),
                     method = "REML",
                     data = full)

#summary(test_2$gam)
summary(sensitivity_pos_vputamen)
#plot(ggpredict(sensitivity_pos_vputamen, 
#               terms = c("age", "mb_resid_z[-2,2]"))) + scale_y_continuous(trans = "reverse")
#plot(ggpredict(sensitivity_pos_vputamen, 
#               terms = c("age", "fss_resid_z[-2,2]"))) + scale_y_continuous(trans = "reverse")
pos_vput_int_fss_margins <- ggpredict(sensitivity_pos_vputamen, 
                                      terms = c("age", "fss_resid_z[-2,-1,0,1,2]"))

pos_vput_int_mb_margins <- ggpredict(sensitivity_pos_vputamen, 
                                      terms = c("age", "mb_resid_z[-2,-1,0,1,2]"))
```


Showing just habitual TV smooths for CIC atlas.
I need to change colors to similar ones in main figure. For now this is fine.

```{r Sensitivity Plots JUST HABITS}
#pos dorsal put age:fss mako "D"
p3 <- ggplot() +
  geom_point(data = full, 
             aes(x = age, 
                 y = cic_pos_dorsal_put_harm, 
                 color = fss_resid_z, 
                 group = id)) + 
  geom_line(data = full, 
            aes(x = age, 
                y = cic_pos_dorsal_put_harm, 
                color = fss_resid_z, 
                group = id)) +
  scale_color_viridis(option = "D", 
                      direction = -1, 
                      alpha = .5,
                      name = "FSS (z-scored)",
                      guide = guide_colorbar(position = "bottom")) +
  scale_fill_viridis(option = "D", 
                     direction = -1, 
                     alpha = .5) +
  new_scale_color() +
  new_scale_fill() +
  geom_smooth(data = pos_dput_int_fss_margins, 
              aes(x = x, 
                  y = predicted, 
                  group = group, 
                  color = group), 
              linewidth = 1.5) +
  scale_color_viridis(discrete = TRUE, 
                      option = "D",
                      direction = -1, 
                      guide = "none") + 
  scale_y_continuous(trans = "reverse") +
  labs(title = "Posterior Dorsal Putamen: Age x FSS Interaction",
       x = "Age (years)",
       y = "Putamen nT2*w") + 
  theme_modern(base_size = 16) +
  geom_text(aes(x = 28, y = 1.21), 
            label = expression("s(Age):FSS " * italic(F) * " = 3.46, " * italic(p) * " = 0.02"),
            size = 3.5, 
            color = "black") +
  geom_text(aes(x = 16.97, y = 0.7),
            label = "p < 0.05",
            size = 4,
            color = "black") +
   geom_text(aes(x = 20.97, y = 0.7),
            label = "n.s.",
            size = 4,
            color = "black") +
  theme(
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    plot.title = element_text(hjust = 0.5)) +
  geom_vline(xintercept = 18.97, 
             linetype = "dashed", 
             color = "black", 
             linewidth = 1)
p3

#pre dorsal put age:fss rocket "C"
p4 <- ggplot() +
  geom_point(data = full, 
             aes(x = age, 
                 y = cic_pre_dorsal_put_harm, 
                 color = fss_resid_z, 
                 group = id)) + 
  geom_line(data = full, 
            aes(x = age, 
                y = cic_pre_dorsal_put_harm, 
                color = fss_resid_z, 
                group = id)) +
  scale_color_viridis(option = "C", 
                      direction = -1, 
                      alpha = .5,
                      name = "FSS (z-scored)",
                      guide = guide_colorbar(position = "bottom")) +
  scale_fill_viridis(option = "C", 
                     direction = -1, 
                     alpha = .5) +
  new_scale_color() +
  new_scale_fill() +
  geom_smooth(data = pre_dput_int_fss_margins, 
              aes(x = x, 
                  y = predicted, 
                  group = group, 
                  color = group), 
              linewidth = 1.5) +
  scale_color_viridis(discrete = TRUE, 
                      option = "C",
                      direction = -1, 
                      guide = "none") + 
  scale_y_continuous(trans = "reverse") +
  labs(title = "Anterior Dorsal Putamen: Age x FSS Interaction",
       x = "Age (years)",
       y = "Putamen nT2*w") + 
  theme_modern(base_size = 16) +
  geom_text(aes(x = 28, y = 1.21), 
            label = expression("s(Age):FSS " * italic(F) * " = 2.49, " * italic(p) * " = 0.09"),
            size = 3.5, 
            color = "black") +
  #geom_text(aes(x = 18.36, y = 0.65),
  #          label = "p < 0.05",
  #          size = 4,
  #          color = "black") +
  # geom_text(aes(x = 24, y = 0.65),
  #          label = "n.s.",
  #          size = 4,
  #          color = "black") +
  #   geom_text(aes(x = 30.36, y = 0.65),
  #          label = "p < 0.05",
  #          size = 4,
  #          color = "black") +
  #geom_vline(xintercept = 20.36, 
  #           linetype = "dashed", 
  #           color = "black", 
  #           linewidth = 1) +
  #geom_vline(xintercept = 28.35, 
  #           linetype = "dashed", 
  #           color = "black", 
  #           linewidth = 1) +
  theme(
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    plot.title = element_text(hjust = 0.5))
p4


#pos ventral put age:fss mako "G"
#Need to adjust geom_text layers
#Also something looks weird
p5 <- ggplot() +
  geom_point(data = full, 
             aes(x = age, 
                 y = cic_pos_ventral_put_harm, 
                 color = fss_resid_z, 
                 group = id)) + 
  geom_line(data = full, 
            aes(x = age, 
                y = cic_pos_ventral_put_harm, 
                color = fss_resid_z, 
                group = id)) +
  scale_color_viridis(option = "D", 
                      direction = -1, 
                      alpha = .5,
                      name = "FSS (z-scored)",
                      guide = guide_colorbar(position = "bottom")) +
  scale_fill_viridis(option = "D", 
                     direction = -1, 
                     alpha = .5) +
  new_scale_color() +
  new_scale_fill() +
  geom_smooth(data = pos_vput_int_fss_margins, 
              aes(x = x, 
                  y = predicted, 
                  group = group, 
                  color = group), 
              linewidth = 1.5) +
  scale_color_viridis(discrete = TRUE, 
                      option = "D",
                      direction = -1, 
                      guide = "none") + 
  scale_y_continuous(trans = "reverse") +
  labs(title = "Posterior Ventral Putamen: Age x FSS Interaction",
       x = "Age (years)",
       y = "Putamen nT2*w") + 
  theme_modern(base_size = 16) +
  geom_text(aes(x = 28, y = 1.21), 
            label = expression("s(Age):FSS " * italic(F) * " = 3.75, " * italic(p) * " = 0.013"),
            size = 3.5, 
            color = "black") +
  geom_text(aes(x = 15.23, y = 0.63),
            label = "p < 0.05",
            size = 4,
            color = "black") +
   geom_text(aes(x = 19.23, y = 0.63),
            label = "n.s.",
            size = 4,
            color = "black") +
  theme(
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    plot.title = element_text(hjust = 0.5)) +
  geom_vline(xintercept = 17.23, 
             linetype = "dashed", 
             color = "black", 
             linewidth = 1)
p5

#pre dorsal put age:mb rocket "C"
p6 <- ggplot() +
  geom_point(data = full, 
             aes(x = age, 
                 y = cic_pre_ventral_put_harm, 
                 color = fss_resid_z, 
                 group = id)) + 
  geom_line(data = full, 
            aes(x = age, 
                y = cic_pre_ventral_put_harm, 
                color = fss_resid_z, 
                group = id)) +
  scale_color_viridis(option = "C", 
                      direction = -1, 
                      alpha = .5,
                      name = "FSS (z-scored)",
                      guide = guide_colorbar(position = "bottom")) +
  scale_fill_viridis(option = "C", 
                     direction = -1, 
                     alpha = .5) +
  new_scale_color() +
  new_scale_fill() +
  geom_smooth(data = pre_vput_int_fss_margins, 
              aes(x = x, 
                  y = predicted, 
                  group = group, 
                  color = group), 
              linewidth = 1.5) +
  scale_color_viridis(discrete = TRUE, 
                      option = "C",
                      direction = -1, 
                      guide = "none") + 
  scale_y_continuous(trans = "reverse") +
  labs(title = "Anterior Ventral Putamen: Age x FSS Interaction",
       x = "Age (years)",
       y = "Putamen nT2*w") + 
  theme_modern(base_size = 16) +
  geom_text(aes(x = 28, y = 1.21), 
            label = expression("s(Age):FSS " * italic(F) * " = 2.99, " * italic(p) * " = 0.053"),
            size = 3.5, 
            color = "black") +
  #geom_text(aes(x = 18.82, y = 0.63),
  #          label = "p < 0.05",
  #          size = 4,
  #          color = "black") +
  # geom_text(aes(x = 22.82, y = 0.63),
  #          label = "n.s.",
  #          size = 4,
  #          color = "black") +
  #geom_vline(xintercept = 20.82, 
  #           linetype = "dashed", 
  #           color = "black", 
  #           linewidth = 1) +
  theme(
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    plot.title = element_text(hjust = 0.5))
p6

q4 <- ggarrange(p4,p3,p6,p5, 
          labels = c("A.", "B.", "C.", "D."),
          ncol = 2,
          nrow = 2, 
          common.legend = FALSE, 
          legend = "bottom")
q4
#This actually sorta works?
#ggsave(filename = "flux_images/sense_iront_jh.png", 
#       plot = q4, device = "png", 
#       dpi = 500, width = 190, height = 120, unit = "mm", scale = 1.5)
```


Figure looking at difference score model fss_mb_diff ~ 1 + + s(age) + s(harox_putamen_harm)

```{r}
full$fssz_mbz_diff <- full$firststagestay_z - full$modelbased_z
full$fssz_mfz_diff <- full$firststagestay_z - full$modelfree_z
full$mbz_mfz_diff <- full$modelbased_z - full$modelfree_z
test2 <- gam(fssz_mbz_diff ~ 1 + sex + visitnum_numeric  +
                       s(age, k = 3, fx = FALSE) +
                s(age, by = harox_putamen_harm, k = 3, fx = FALSE) +
               #s(harox_pallidum_harm, k = 3, fx = F) +
               #s(cic_pre_dorsal_put_harm, k = 3, fx = F) +
               #s(cic_pos_dorsal_put_harm, k = 3, fx = F) +
               #s(age, by = harox_caudate_harm, k = 3, fx = F) +
               #ti(harox_caudate_harm, harox_putamen_harm, k = 3, fx = F) +
               #s(harox_nacc_harm, k = 3, fx = F) +
               #s(harox_pallidum_harm, k = 3, fx = F) +
                #ti(age, harox_putamen_harm, k = 3, fx = FALSE) +
                s(id_fac, bs = "re"),
                     method = "REML",
                     data = full)
summary(test2)
plot(ggpredict(test2, terms = c("age","harox_putamen_harm")))
#margins
sensitivity_diff_margins <- ggpredict(test2, 
                                      terms = c("age", "harox_putamen_harm"))
plot(johnson_neyman(sensitivity_diff_margins))
#Figure
pt <- ggplot() +
  geom_point(data = full, 
             aes(x = harox_putamen_harm, 
                 y = fssz_mbz_diff, 
                 color = age, 
                 group = id)) + 
  #geom_line(data = full, 
  #          aes(x = harox_putamen_harm, 
  #              y = fssz_mbz_diff, 
  #              color = fss_resid_z, 
  #              group = id)) +
  scale_color_viridis(option = "C", 
                      alpha = .5,
                      name = "Age (years)",
                      guide = guide_colorbar(position = "bottom")) +
  new_scale_color() +
  new_scale_fill() +
  geom_smooth(data = sensitivity_diff_margins, 
              aes(x = x, 
                  y = predicted), 
              linewidth = 1.5) +
  scale_color_viridis(discrete = TRUE, 
                      option = "C",
                      direction = -1, 
                      guide = "none") + 
  scale_x_continuous(trans = "reverse") +
  scale_fill_viridis(option = "C", 
                     direction = -1, 
                     alpha = .5) +
  theme_modern()
pt
```

Test Val... yo what... this attempt actually did work! Need to change.

```{r Small test}
#pos dorsal put age:fss mako "D" Keep these aesthetics for plotting.....!!!!!!!!!!!
p3 <- ggplot() +
  geom_point(data = full, 
             aes(x = age, 
                 y = cic_pos_dorsal_put_harm, 
                 color = fss_resid_z, 
                 group = id),
             size = 0.4) + 
  geom_line(data = full, 
            aes(x = age, 
                y = cic_pos_dorsal_put_harm, 
                color = fss_resid_z, 
                group = id),
            linewidth = 0.4) +
  scale_color_viridis(option = "D", 
                      direction = -1, 
                      alpha = .5,
                      name = "",
                      guide = guide_colorbar(position = "right")) +
  scale_fill_viridis(option = "D", 
                     direction = -1, 
                     alpha = .5) +
  new_scale_color() +
  new_scale_fill() +
  geom_smooth(data = pos_dput_int_fss_margins, 
              aes(x = x, 
                  y = predicted, 
                  group = group, 
                  color = group), 
              linewidth = .4) +
  scale_color_viridis(discrete = TRUE, 
                      option = "D",
                      direction = -1, 
                      guide = "none") + 
  scale_y_continuous(trans = "reverse") +
  labs(title = "Posterior Dorsal Putamen: Age x FSS Interaction",
       x = "Age (years)",
       y = "Putamen nT2*w") + 
  theme_modern() +
  geom_text(aes(x = 28, y = 1.21), 
            label = expression("s(Age):FSS " * italic(F) * " = 3.46, " * italic(p) * " = 0.02"),
            size = 2, 
            color = "black") +
  geom_text(aes(x = 16.97, y = 0.7),
            label = "p < 0.05",
            size = 2,
            color = "black") +
   geom_text(aes(x = 20.97, y = 0.7),
            label = "n.s.",
            size = 2,
            color = "black") +
  theme(
    axis.title.x = element_text(size = 7, margin = margin(t = 2)),
    axis.title.y = element_text(size = 7, margin = margin(r = 2)),
    axis.text.x = element_text(size = 6),
    axis.text.y = element_text(size = 6),
    plot.title = element_text(size = 7, hjust = 0.5),
    axis.line = element_line(size = .2),
    axis.ticks = element_line(size = .2),
    legend.text = element_text(size = 5),
    legend.title = element_text(size = 6),
    legend.key.size = unit(0.2, "cm")
    ) +
  geom_vline(xintercept = 18.97, 
             linetype = "dashed", 
             color = "black", 
             linewidth = .3)
p3

#p3 <- p3 + theme(
#  plot.margin = unit(c(2,2,2,2), "mm")
#)

ggsave(filename = "flux_images/small/testing_size_300dpi_please8.png", 
       plot = p3,
       device = "png", 
       dpi = 500, 
       units = "mm",
       width = 90, 
       height = 60)
# limitsize = FALSE
#pre dorsal put age:fss rocket "C"
p4 <- ggplot() +
  geom_point(data = full, 
             aes(x = age, 
                 y = cic_pre_dorsal_put_harm, 
                 color = fss_resid_z, 
                 group = id)) + 
  geom_line(data = full, 
            aes(x = age, 
                y = cic_pre_dorsal_put_harm, 
                color = fss_resid_z, 
                group = id)) +
  scale_color_viridis(option = "C", 
                      direction = -1, 
                      alpha = .5,
                      name = "FSS (z-scored)",
                      guide = guide_colorbar(position = "bottom")) +
  scale_fill_viridis(option = "C", 
                     direction = -1, 
                     alpha = .5) +
  new_scale_color() +
  new_scale_fill() +
  geom_smooth(data = pre_dput_int_fss_margins, 
              aes(x = x, 
                  y = predicted, 
                  group = group, 
                  color = group), 
              linewidth = 1.5) +
  scale_color_viridis(discrete = TRUE, 
                      option = "C",
                      direction = -1, 
                      guide = "none") + 
  scale_y_continuous(trans = "reverse") +
  labs(title = "Anterior Dorsal Putamen: Age x FSS Interaction",
       x = "Age (years)",
       y = "Putamen nT2*w") + 
  theme_modern(base_size = 16) +
  geom_text(aes(x = 28, y = 1.21), 
            label = expression("s(Age):FSS " * italic(F) * " = 2.49, " * italic(p) * " = 0.09"),
            size = 3.5, 
            color = "black") +
  #geom_text(aes(x = 18.36, y = 0.65),
  #          label = "p < 0.05",
  #          size = 4,
  #          color = "black") +
  # geom_text(aes(x = 24, y = 0.65),
  #          label = "n.s.",
  #          size = 4,
  #          color = "black") +
  #   geom_text(aes(x = 30.36, y = 0.65),
  #          label = "p < 0.05",
  #          size = 4,
  #          color = "black") +
  #geom_vline(xintercept = 20.36, 
  #           linetype = "dashed", 
  #           color = "black", 
  #           linewidth = 1) +
  #geom_vline(xintercept = 28.35, 
  #           linetype = "dashed", 
  #           color = "black", 
  #           linewidth = 1) +
  theme(
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    plot.title = element_text(hjust = 0.5))
p4


#pos ventral put age:fss mako "G"
#Need to adjust geom_text layers
#Also something looks weird
p5 <- ggplot() +
  geom_point(data = full, 
             aes(x = age, 
                 y = cic_pos_ventral_put_harm, 
                 color = fss_resid_z, 
                 group = id)) + 
  geom_line(data = full, 
            aes(x = age, 
                y = cic_pos_ventral_put_harm, 
                color = fss_resid_z, 
                group = id)) +
  scale_color_viridis(option = "D", 
                      direction = -1, 
                      alpha = .5,
                      name = "FSS (z-scored)",
                      guide = guide_colorbar(position = "bottom")) +
  scale_fill_viridis(option = "D", 
                     direction = -1, 
                     alpha = .5) +
  new_scale_color() +
  new_scale_fill() +
  geom_smooth(data = pos_vput_int_fss_margins, 
              aes(x = x, 
                  y = predicted, 
                  group = group, 
                  color = group), 
              linewidth = 1.5) +
  scale_color_viridis(discrete = TRUE, 
                      option = "D",
                      direction = -1, 
                      guide = "none") + 
  scale_y_continuous(trans = "reverse") +
  labs(title = "Posterior Ventral Putamen: Age x FSS Interaction",
       x = "Age (years)",
       y = "Putamen nT2*w") + 
  theme_modern(base_size = 16) +
  geom_text(aes(x = 28, y = 1.21), 
            label = expression("s(Age):FSS " * italic(F) * " = 3.75, " * italic(p) * " = 0.013"),
            size = 3.5, 
            color = "black") +
  geom_text(aes(x = 15.23, y = 0.63),
            label = "p < 0.05",
            size = 4,
            color = "black") +
   geom_text(aes(x = 19.23, y = 0.63),
            label = "n.s.",
            size = 4,
            color = "black") +
  theme(
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    plot.title = element_text(hjust = 0.5)) +
  geom_vline(xintercept = 17.23, 
             linetype = "dashed", 
             color = "black", 
             linewidth = 1)
p5

#pre dorsal put age:mb rocket "C"
p6 <- ggplot() +
  geom_point(data = full, 
             aes(x = age, 
                 y = cic_pre_ventral_put_harm, 
                 color = fss_resid_z, 
                 group = id)) + 
  geom_line(data = full, 
            aes(x = age, 
                y = cic_pre_ventral_put_harm, 
                color = fss_resid_z, 
                group = id)) +
  scale_color_viridis(option = "C", 
                      direction = -1, 
                      alpha = .5,
                      name = "FSS (z-scored)",
                      guide = guide_colorbar(position = "bottom")) +
  scale_fill_viridis(option = "C", 
                     direction = -1, 
                     alpha = .5) +
  new_scale_color() +
  new_scale_fill() +
  geom_smooth(data = pre_vput_int_fss_margins, 
              aes(x = x, 
                  y = predicted, 
                  group = group, 
                  color = group), 
              linewidth = 1.5) +
  scale_color_viridis(discrete = TRUE, 
                      option = "C",
                      direction = -1, 
                      guide = "none") + 
  scale_y_continuous(trans = "reverse") +
  labs(title = "Anterior Ventral Putamen: Age x FSS Interaction",
       x = "Age (years)",
       y = "Putamen nT2*w") + 
  theme_modern(base_size = 16) +
  geom_text(aes(x = 28, y = 1.21), 
            label = expression("s(Age):FSS " * italic(F) * " = 2.99, " * italic(p) * " = 0.053"),
            size = 3.5, 
            color = "black") +
  #geom_text(aes(x = 18.82, y = 0.63),
  #          label = "p < 0.05",
  #          size = 4,
  #          color = "black") +
  # geom_text(aes(x = 22.82, y = 0.63),
  #          label = "n.s.",
  #          size = 4,
  #          color = "black") +
  #geom_vline(xintercept = 20.82, 
  #           linetype = "dashed", 
  #           color = "black", 
  #           linewidth = 1) +
  theme(
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    plot.title = element_text(hjust = 0.5))
p6

q4 <- ggarrange(p4,p3,p6,p5, 
          labels = c("A.", "B.", "C.", "D."),
          ncol = 2,
          nrow = 2, 
          common.legend = FALSE, 
          legend = "bottom")
q4
#This actually sorta works?
#ggsave(filename = "flux_images/sense_iront_jh.png", 
#       plot = q4, device = "png", 
#       dpi = 500, width = 190, height = 120, unit = "mm", scale = 1.5)
```

test

```{r}
p2 <- ggplot() +
  geom_point(data = full, 
             aes(x = mb_resid_z, 
                 y = harox_putamen_harm,
                 colour = age),
             alpha = 0.7) + 
    scale_color_viridis(option = "F", 
                      direction = -1, 
                      alpha = .7,
                      name = "Age",
                      guide = guide_colorbar(position = "bottom")) +
    geom_smooth(data = full, 
                aes(x = mb_resid_z, 
                    y = harox_putamen_harm,
                    group = age_cat), 
                method = "gam") +
  scale_y_continuous(trans = "reverse") +
  theme_modern(base_size = 12) +
  labs(x = "First Stage Stay (z-scored)",
       y = "Putamen nT2*w") +
    theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12)
  ) +
  facet_wrap(~age_cat) +
  geom_vline(xintercept = 0)
  
p2
```

